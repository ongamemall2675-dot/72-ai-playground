<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ–¼ï¸ AI ì´ë¯¸ì§€ ìƒì„±ê¸° v2.6</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ–¼ï¸</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700&family=Fira+Code&display=swap"
        rel="stylesheet">
    <style>
        /* CSS ì „ì—­ ë³€ìˆ˜ */
        :root {
            --dark-bg: #0a0a0f;
            --dark-surface: #12121a;
            --dark-panel: #1a1a25;
            --dark-border: #2a2a3a;
            --gold: #d4af37;
            --gold-light: #f0d060;
            --text: #e5e5e5;
            --text-muted: #888;
            --purple: #a855f7;
            --success: #22c55e;
            --error: #ef4444;
            --info: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* í—¤ë” */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background: var(--dark-surface);
            border-bottom: 1px solid var(--dark-border);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gold);
        }

        .version-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.5rem;
            background: rgba(212, 175, 55, 0.15);
            color: var(--gold);
            border-radius: 99px;
            margin-left: 0.5rem;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 99px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .api-status.ok {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .api-status.no {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.4rem 0.75rem;
            background: var(--dark-panel);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
        }

        .btn-icon:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ - 2ì—´ êµ¬ì¡° */
        .main-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            height: calc(100vh - 52px);
        }

        /* ì¢Œì¸¡ íŒ¨ë„ - ì¥ë©´ ëª©ë¡ */
        .scenes-panel {
            background: var(--dark-surface);
            border-right: 1px solid var(--dark-border);
            padding: 1rem;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* JSON ê°€ì ¸ì˜¤ê¸° */
        .import-area {
            border: 2px dashed var(--dark-border);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .import-area:hover,
        .import-area.dragover {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.05);
        }

        .import-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .import-text {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ì¥ë©´ ì¹´ë“œ */
        .scene-card {
            background: var(--dark-panel);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scene-card:hover,
        .scene-card.active {
            border-color: var(--gold);
        }

        .scene-card.active {
            background: rgba(212, 175, 55, 0.08);
        }

        .scene-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .scene-id {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gold);
        }

        /* ë°°ì¹˜ ìƒì„± ê²°ê³¼ ì•„ì´í…œ */
        .batch-result-item {
            background: var(--dark-panel);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 0.6rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
        }

        .batch-result-item.success {
            border-left: 3px solid var(--success);
        }

        .batch-result-item.error {
            border-left: 3px solid var(--error);
        }

        .batch-result-item.pending {
            border-left: 3px solid var(--info);
        }

        .batch-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.35rem;
        }

        .batch-result-scene {
            font-weight: 600;
            color: var(--gold);
        }

        .batch-result-status {
            font-size: 0.65rem;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
        }

        .batch-result-status.ok {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .batch-result-status.fail {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .batch-result-status.wait {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
        }

        .batch-result-prompt {
            color: var(--text-muted);
            line-height: 1.4;
            margin-top: 0.25rem;
        }

        .batch-result-prompt .ko {
            color: var(--success);
            font-size: 0.7rem;
            margin-bottom: 0.2rem;
        }

        .batch-result-prompt .en {
            font-family: 'Fira Code', monospace;
            font-size: 0.68rem;
        }

        .scene-status {
            font-size: 0.6rem;
            padding: 0.1rem 0.35rem;
            border-radius: 4px;
        }

        .scene-status.ready {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
        }

        .scene-status.completed {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .scene-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .scene-keywords {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            margin-top: 0.4rem;
        }

        .scene-keyword {
            font-size: 0.6rem;
            padding: 0.1rem 0.3rem;
            background: var(--dark-border);
            border-radius: 3px;
            color: var(--text-muted);
        }

        /* ê²°ê³¼ íŒ¨ë„ - ì˜¤ë¥¸ìª½ */
        .results-panel {
            background: var(--dark-bg);
            padding: 1rem;
            overflow-y: auto;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--dark-border);
        }

        .results-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gold);
        }

        .results-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* ì¸ë„¤ì¼ ì„¹ì…˜ */
        .thumbnail-section {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(212, 175, 55, 0.1));
            border: 1px solid var(--purple);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .thumbnail-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .thumbnail-section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--purple);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .thumbnail-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .thumbnail-card {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
        }

        .thumbnail-card:hover {
            transform: translateY(-2px);
            border-color: var(--purple);
        }

        .thumbnail-image-container {
            position: relative;
            aspect-ratio: 16/9;
            background: var(--dark-panel);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .thumbnail-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail-placeholder {
            color: var(--text-muted);
            font-size: 2rem;
        }

        .thumbnail-korean-text {
            position: absolute;
            bottom: 0.5rem;
            left: 0.5rem;
            right: 0.5rem;
            background: rgba(0,0,0,0.7);
            color: var(--gold);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 700;
            text-align: center;
        }

        .thumbnail-info {
            padding: 0.75rem;
        }

        .thumbnail-concept {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            line-height: 1.4;
            max-height: 2.8em;
            overflow: hidden;
        }

        .thumbnail-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .thumbnail-actions select {
            flex: 1;
            min-width: 80px;
            padding: 0.35rem;
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.65rem;
        }

        .thumbnail-actions button {
            padding: 0.35rem 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 0.65rem;
            cursor: pointer;
            background: var(--purple);
            color: white;
        }

        .thumbnail-actions button:hover {
            opacity: 0.9;
        }

        .thumbnail-actions button.download {
            background: var(--success);
        }

        .thumbnail-loading {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
        }

        /* ì¥ë©´ ê²°ê³¼ ì¹´ë“œ - 3ì—´ ë ˆì´ì•„ì›ƒ */
        .scene-result-card {
            display: grid;
            grid-template-columns: minmax(150px, 1fr) minmax(300px, 2fr) 200px;
            gap: 1rem;
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .scene-result-card.generating {
            border-color: var(--info);
        }

        .scene-result-card.completed {
            border-color: var(--success);
        }

        /* ì™¼ìª½: ëŒ€ë³¸ */
        .scene-script-col {
            border-right: 1px solid var(--dark-border);
            padding-right: 1rem;
        }

        .scene-script-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .scene-number {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        .script-text {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--text);
        }

        /* ì¤‘ì•™: í”„ë¡¬í”„íŠ¸ */
        .scene-prompt-col {
            border-right: 1px solid var(--dark-border);
            padding-right: 1rem;
        }

        .prompt-section {
            margin-bottom: 0.75rem;
        }

        .prompt-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .prompt-ko-text {
            font-size: 0.8rem;
            color: var(--success);
            line-height: 1.4;
            padding: 0.5rem;
            background: rgba(34, 197, 94, 0.05);
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .prompt-en-text {
            font-size: 0.75rem;
            font-family: 'Fira Code', monospace;
            color: var(--text-muted);
            line-height: 1.4;
            padding: 0.5rem;
            background: var(--dark-panel);
            border-radius: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        /* ì˜¤ë¥¸ìª½: ì´ë¯¸ì§€ */
        .scene-image-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .image-preview {
            width: 100%;
            aspect-ratio: 16/9;
            background: var(--dark-panel);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid var(--dark-border);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-placeholder {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
        }

        .image-actions {
            display: flex;
            gap: 0.35rem;
            width: 100%;
        }

        .btn-generate-single {
            flex: 1;
            padding: 0.4rem;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            border: none;
            border-radius: 6px;
            color: #000;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-regenerate {
            padding: 0.4rem 0.6rem;
            background: var(--dark-panel);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.7rem;
            cursor: pointer;
        }

        /* ì„¤ì • íŒ¨ë„ - ì™¼ìª½ */
        .settings-panel {
            background: var(--dark-surface);
            border-right: 1px solid var(--dark-border);
            padding: 1rem;
            overflow-y: auto;
        }

        /* ì¤‘ì•™ íŒ¨ë„ - ì—ë””í„° (ì œê±°, settings-panelë¡œ ëŒ€ì²´) */
        .editor-panel {
            padding: 1rem;
            overflow-y: auto;
        }

        .section-box {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gold);
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ë””ìì´ë„ˆ ì„¹ì…˜ - íƒ­ */
        .designer-tabs {
            display: flex;
            gap: 0.35rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 0.25rem;
            flex-wrap: wrap;
        }

        .designer-tab {
            padding: 0.4rem 0.75rem;
            font-size: 0.7rem;
            background: var(--dark-panel);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .designer-tab:hover,
        .designer-tab.active {
            border-color: var(--gold);
            color: var(--gold);
        }

        .designer-tab.active {
            background: rgba(212, 175, 55, 0.1);
        }

        .designer-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .designer-card {
            position: relative;
            padding: 0.5rem;
            background: var(--dark-panel);
            border: 2px solid var(--dark-border);
            border-radius: 10px;
            text-align: center;
            transition: all 0.2s;
        }

        .designer-card:hover,
        .designer-card.active {
            border-color: var(--gold);
        }

        .designer-card.active {
            background: rgba(212, 175, 55, 0.1);
        }

        .designer-card-inner {
            cursor: pointer;
            padding: 0.25rem;
        }

        .designer-icon {
            font-size: 1.3rem;
            margin-bottom: 0.15rem;
        }

        .designer-name {
            font-size: 0.6rem;
            color: var(--text);
            line-height: 1.2;
        }

        .designer-card .category-badge {
            font-size: 0.5rem;
            padding: 0.1rem 0.3rem;
            background: var(--dark-border);
            border-radius: 3px;
            margin-top: 0.2rem;
            display: inline-block;
        }

        /* ì¦ê²¨ì°¾ê¸° ë²„íŠ¼ */
        .favorite-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 18px;
            height: 18px;
            padding: 0;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.6rem;
            opacity: 0.4;
            transition: opacity 0.2s;
        }

        .designer-card:hover .favorite-btn {
            opacity: 0.8;
        }

        .favorite-btn.active {
            opacity: 1;
        }

        .favorite-btn:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        /* AI ì¶”ì²œ ë°•ìŠ¤ */
        .ai-recommend-box {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(212, 175, 55, 0.1));
            border: 1px solid var(--purple);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem
        }

        .ai-recommend-input {
            display: flex;
            gap: 0.5rem
        }

        .ai-recommend-input input {
            flex: 1;
            padding: 0.6rem;
            background: var(--dark-panel);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.8rem
        }

        .ai-recommend-input button {
            padding: 0.6rem 1rem;
            background: var(--purple);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-size: 0.75rem;
            cursor: pointer;
            white-space: nowrap
        }

        .ai-recommend-result {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--dark-panel);
            border-radius: 8px;
            display: none
        }

        .ai-recommend-result.show {
            display: block
        }

        /* í”„ë¡¬í”„íŠ¸ ì˜ì—­ - ë¯¸ë“œì €ë‹ˆ ìŠ¤íƒ€ì¼ */
        .prompt-container {
            position: relative
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem
        }

        .prompt-sync-btn {
            padding: 0.35rem 0.75rem;
            background: var(--info);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.35rem
        }

        .prompt-sync-btn:disabled {
            opacity: 0.5
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            display: inline-block
        }

        .sync-indicator.syncing {
            animation: pulse 1s infinite
        }

        .sync-indicator.unsynced {
            background: var(--error)
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: 0.3
            }
        }

        .prompt-textarea {
            width: 100%;
            padding: 0.875rem;
            background: var(--dark-panel);
            border: 1px solid var(--dark-border);
            border-radius: 10px;
            color: var(--text);
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            resize: vertical;
            min-height: 100px;
            line-height: 1.5
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--gold)
        }

        .prompt-textarea.ko {
            font-family: 'Pretendard', sans-serif
        }

        .prompt-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem
        }

        .prompt-label .lang-badge {
            font-size: 0.6rem;
            padding: 0.1rem 0.4rem;
            border-radius: 4px
        }

        .prompt-label .lang-badge.en {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info)
        }

        .prompt-label .lang-badge.ko {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success)
        }

        .quick-tags {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
            margin-top: 0.75rem
        }

        .quick-tag {
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            background: var(--dark-panel);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-muted)
        }

        .quick-tag:hover {
            border-color: var(--gold);
            color: var(--gold)
        }

        .quick-tag.mj-param {
            background: rgba(168, 85, 247, 0.15);
            border-color: var(--purple);
            color: var(--purple)
        }

        /* ì„¤ì • ì˜ì—­ */
        .settings-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem
        }

        .setting-group label {
            font-size: 0.7rem;
            color: var(--text-muted);
            display: block;
            margin-bottom: 0.35rem
        }

        .setting-select {
            width: 100%;
            padding: 0.5rem;
            background: var(--dark-panel);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.8rem
        }

        .setting-select:focus {
            outline: none;
            border-color: var(--gold)
        }

        /* ë²„íŠ¼ */
        .btn-generate {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--gold), var(--gold-light));
            color: #000;
            font-weight: 700;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin-top: 1rem
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.3)
        }

        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none
        }

        .btn-secondary {
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
            font-weight: 500;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-top: 0.5rem
        }

        /* ê°¤ëŸ¬ë¦¬ */
        .gallery-panel {
            background: var(--dark-surface);
            border-left: 1px solid var(--dark-border);
            padding: 1rem;
            overflow-y: auto
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem
        }

        .gallery-item {
            position: relative;
            aspect-ratio: 16/9;
            background: var(--dark-panel);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .gallery-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            font-size: 0.7rem
        }

        .gallery-item-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s
        }

        .gallery-item:hover .gallery-item-overlay {
            opacity: 1
        }

        .gallery-badge {
            position: absolute;
            top: 0.35rem;
            left: 0.35rem;
            font-size: 0.6rem;
            padding: 0.15rem 0.35rem;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 4px
        }

        /* ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ */
        .image-lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding: 2rem;
        }
        .image-lightbox.show {
            display: flex;
        }
        .lightbox-content {
            position: relative;
            max-width: 95vw;
            max-height: 90vh;
        }
        .lightbox-content img {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .lightbox-close:hover {
            opacity: 1;
        }
        .lightbox-info {
            position: absolute;
            bottom: -50px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .lightbox-btn {
            padding: 0.5rem 1rem;
            background: var(--gold);
            color: #000;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        .lightbox-btn:hover {
            background: var(--gold-light);
        }
        .lightbox-btn.secondary {
            background: var(--dark-panel);
            color: var(--text);
            border: 1px solid var(--dark-border);
        }
        .lightbox-btn.secondary:hover {
            background: var(--dark-surface);
        }
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .lightbox-nav:hover {
            background: rgba(255,255,255,0.2);
        }
        .lightbox-nav.prev { left: -70px; }
        .lightbox-nav.next { right: -70px; }

        /* ì´ë¯¸ì§€ ì•¡ì…˜ ë²„íŠ¼ ê°œì„  */
        .image-actions {
            display: flex;
            gap: 0.35rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }
        .image-actions button {
            flex: 1;
            min-width: 45px;
            padding: 0.4rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-generate-single {
            background: var(--gold);
            color: #000;
        }
        .btn-generate-single:hover:not(:disabled) {
            background: var(--gold-light);
        }
        .btn-generate-single:disabled {
            background: var(--dark-border);
            color: var(--text-muted);
            cursor: not-allowed;
        }
        .btn-regenerate {
            background: var(--info);
            color: white;
        }
        .btn-regenerate:hover:not(:disabled) {
            background: #5b9bf6;
        }
        .btn-regenerate:disabled {
            background: var(--dark-border);
            color: var(--text-muted);
            cursor: not-allowed;
        }
        .btn-download-single {
            background: var(--success);
            color: white;
        }
        .btn-download-single:hover:not(:disabled) {
            background: #3dd66e;
        }
        .btn-download-single:disabled {
            background: var(--dark-border);
            color: var(--text-muted);
            cursor: not-allowed;
        }
        .btn-zoom {
            background: var(--purple);
            color: white;
        }
        .btn-zoom:hover:not(:disabled) {
            background: #b875f7;
        }
        .btn-zoom:disabled {
            background: var(--dark-border);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* ì´ë¯¸ì§€ í”„ë¦¬ë·° í´ë¦­ ê°€ëŠ¥ */
        .image-preview {
            cursor: pointer;
            position: relative;
        }
        .image-preview:hover::after {
            content: 'ğŸ” í´ë¦­í•˜ì—¬ í™•ëŒ€';
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            border-radius: 6px;
        }
        .image-preview.no-image:hover::after {
            display: none;
        }

        /* ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 1rem
        }

        .modal-overlay.show {
            display: flex
        }

        .modal {
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column
        }

        .modal-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--dark-border);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .modal-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gold)
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer
        }

        .modal-body {
            padding: 1.25rem;
            overflow-y: auto;
            flex: 1
        }

        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--dark-border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem
        }

        /* íƒ­ */
        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--dark-border);
            margin-bottom: 1rem
        }

        .tab {
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent
        }

        .tab:hover {
            color: var(--text)
        }

        .tab.active {
            color: var(--gold);
            border-bottom-color: var(--gold)
        }

        .tab-content {
            display: none
        }

        .tab-content.active {
            display: block
        }

        /* API í‚¤ ì„¤ì • */
        .api-key-item {
            background: var(--dark-panel);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 0.75rem
        }

        .api-key-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem
        }

        .api-key-name {
            font-weight: 600;
            font-size: 0.85rem
        }

        .api-key-status {
            font-size: 0.65rem;
            padding: 0.15rem 0.5rem;
            border-radius: 99px
        }

        .api-key-status.ok {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success)
        }

        .api-key-status.no {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error)
        }

        .api-key-row {
            display: flex;
            gap: 0.5rem
        }

        .api-key-input {
            flex: 1;
            padding: 0.5rem;
            background: var(--dark-bg);
            border: 1px solid var(--dark-border);
            border-radius: 6px;
            color: var(--text);
            font-family: monospace;
            font-size: 0.75rem
        }

        .api-key-btn {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600
        }

        .api-key-btn.test {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info)
        }

        .api-key-btn.save {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success)
        }

        /* í¼ */
        .form-group {
            margin-bottom: 1rem
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.4rem
        }

        .form-input {
            width: 100%;
            padding: 0.6rem;
            background: var(--dark-panel);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.85rem
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold)
        }

        /* ìœ í‹¸ë¦¬í‹° */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--dark-surface);
            border: 1px solid var(--dark-border);
            border-radius: 12px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            z-index: 3000
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--dark-border);
            border-radius: 3px;
            margin-top: 0.75rem;
            overflow: hidden
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            transition: width 0.3s
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--dark-border);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div>
            <span class="logo">ğŸ–¼ï¸ AI ì´ë¯¸ì§€ ìƒì„±ê¸°</span>
            <span class="version-badge">v2.5</span>
        </div>
        <div class="header-status">
            <div class="api-status no" id="apiStatusBadge">
                <span>âš¡</span>
                <span id="apiStatusText">API ë¯¸ì„¤ì •</span>
            </div>
            <div class="header-actions">
                <button class="btn-icon" onclick="openDesignerModal()">ğŸ‘¤ ë””ìì´ë„ˆ</button>
                <button class="btn-icon" onclick="openSettingsModal()">âš™ï¸ ì„¤ì •</button>
                <a href="/docs" class="btn-icon" style="text-decoration:none">ğŸ“– API</a>
            </div>
        </div>
    </header>

    <div class="main-container">
        <!-- ì¢Œì¸¡: ì„¤ì • íŒ¨ë„ -->
        <div class="settings-panel">
            <!-- JSON ê°€ì ¸ì˜¤ê¸° -->
            <div class="section-box">
                <div class="section-title">
                    <span>ğŸ“ ëŒ€ë³¸ ê°€ì ¸ì˜¤ê¸°</span>
                </div>
                <div class="import-area" id="importArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)"
                    ondragleave="handleDragLeave(event)">
                    <div class="import-icon">ğŸ“</div>
                    <div class="import-text">M-06 JSON íŒŒì¼ì„<br>ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­</div>
                    <input type="file" id="fileInput" accept=".json" style="display:none"
                        onchange="handleFileSelect(event)">
                </div>
            </div>

            <!-- AI ë””ìì´ë„ˆ ì¶”ì²œ -->
            <div class="section-box">
                <div class="section-title">
                    <span>âœ¨ AI ë””ìì´ë„ˆ ì¶”ì²œ</span>
                </div>
                <div class="ai-recommend-box">
                    <div class="ai-recommend-input">
                        <input type="text" id="recommendInput" placeholder="ì˜ˆ: ë¶€ë™ì‚° ë§¤ë¬¼ ì†Œê°œ ì˜ìƒ">
                        <button onclick="getAIRecommendation()">ğŸ¯ ì¶”ì²œ</button>
                    </div>
                    <div class="ai-recommend-result" id="recommendResult">
                        <div style="font-size:0.8rem;font-weight:600;color:var(--gold);margin-bottom:0.5rem">ì¶”ì²œ ë””ìì´ë„ˆ
                        </div>
                        <div id="recommendedDesigner" style="font-size:0.85rem"></div>
                        <div id="recommendReason" style="font-size:0.75rem;color:var(--text-muted);margin-top:0.35rem">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë””ìì´ë„ˆ ì„ íƒ -->
            <div class="section-box">
                <div class="section-title">
                    <span>ğŸ¨ ë””ìì´ë„ˆ ì„ íƒ</span>
                    <button class="btn-icon" onclick="openDesignerModal()"
                        style="padding:0.25rem 0.5rem;font-size:0.65rem">ê´€ë¦¬</button>
                </div>
                <div class="designer-tabs"></div>
                <div class="designer-grid" id="designerGrid"></div>
            </div>

            <!-- ìƒì„± ì„¤ì • -->
            <div class="section-box">
                <div class="section-title">
                    <span>âš™ï¸ ìƒì„± ì„¤ì •</span>
                </div>
                <div class="settings-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem">
                    <div class="setting-group">
                        <label>í”„ë¡¬í”„íŠ¸ AI</label>
                        <select class="setting-select" id="promptAI">
                            <option value="gpt4o_mini" selected>GPT-4o Mini</option>
                            <option value="gemini">Gemini 2.0</option>
                            <option value="openai">GPT-4o</option>
                            <option value="claude">Claude</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>ì´ë¯¸ì§€ ìƒì„± API</label>
                        <select class="setting-select" id="imageAPI">
                            <option value="vertex" selected>Vertex AI Imagen (ìë™)</option>
                            <option value="vertex-nano-banana">Nano Banana (Vertex)</option>
                            <option value="vertex-nano-banana-pro">Nano Banana Pro (Vertex)</option>
                            <option value="dalle3">DALL-E 3 (OpenAI)</option>
                            <option value="replicate">Replicate Flux</option>
                            <option value="replicate-seedream">SeeDream-4 (ByteDance)</option>
                            <option value="replicate-nano-banana">Nano Banana (Replicate)</option>
                            <option value="replicate-nano-banana-pro">Nano Banana Pro (Replicate)</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>ë¹„ìœ¨</label>
                        <select class="setting-select" id="imageSize">
                            <option value="1792x1024">16:9 ê°€ë¡œ</option>
                            <option value="1024x1792">9:16 ì„¸ë¡œ</option>
                            <option value="1024x1024">1:1 ì •ì‚¬ê°í˜•</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label>í•´ìƒë„</label>
                        <select class="setting-select" id="imageResolution">
                            <option value="1k">1K (1024px)</option>
                            <option value="2k" selected>2K (2048px)</option>
                            <option value="4k">4K (4096px)</option>
                            <option value="8k">8K (8192px)</option>
                        </select>
                    </div>
                </div>

                <!-- í”„ë¡¬í”„íŠ¸ ë°°ì¹˜ ìƒì„± ë²„íŠ¼ -->
                <button class="btn-generate" id="generatePromptsBtn" onclick="generateAllPrompts()"
                    style="margin-top:1rem">
                    ğŸ“ ì „ì²´ í”„ë¡¬í”„íŠ¸ ìƒì„±
                </button>

                <div class="progress-bar" id="progressBar" style="display:none">
                    <div class="progress-fill" id="progressFill" style="width:0%"></div>
                </div>
                <div id="progressText"
                    style="font-size:0.75rem;color:var(--text-muted);text-align:center;margin-top:0.5rem"></div>
            </div>
        </div>

        <!-- ìš°ì¸¡: ê²°ê³¼ íŒ¨ë„ -->
        <div class="results-panel">
            <!-- ì¸ë„¤ì¼ ì„¹ì…˜ (ìµœìƒë‹¨) -->
            <div class="thumbnail-section" id="thumbnailSection" style="display:none">
                <div class="thumbnail-section-header">
                    <div class="thumbnail-section-title">
                        ğŸ¬ ì¸ë„¤ì¼ (<span id="thumbnailCount">3</span>ê°œ)
                    </div>
                    <div style="display:flex;gap:0.5rem;align-items:center;">
                        <select id="thumbnailAI" style="padding:0.3rem;background:var(--dark-bg);border:1px solid var(--dark-border);border-radius:4px;color:var(--text);font-size:0.7rem;">
                            <option value="gemini">Gemini 2.0</option>
                            <option value="openai">GPT-4o</option>
                            <option value="gpt4o_mini">GPT-4o mini</option>
                            <option value="claude">Claude</option>
                        </select>
                        <button class="btn-icon" onclick="generateThumbnailPrompts()" id="genThumbnailBtn" style="font-size:0.7rem;">
                            ğŸ“ ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ ìƒì„±
                        </button>
                        <button class="btn-icon" onclick="generateAllThumbnailImages()" id="genAllThumbnailImagesBtn" style="font-size:0.7rem;" disabled>
                            ğŸ–¼ï¸ ì „ì²´ ìƒì„±
                        </button>
                    </div>
                </div>
                <div class="thumbnail-grid" id="thumbnailGrid">
                    <!-- ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ -->
                    <div class="thumbnail-empty-state" style="text-align:center;padding:2rem;color:var(--text-muted);">
                        <div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ¬</div>
                        <div>ëŒ€ë³¸ì„ ê°€ì ¸ì˜¤ê³  "ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                    </div>
                </div>
            </div>

            <div class="results-header">
                <div class="results-title">ğŸ“‹ ì¥ë©´ ê²°ê³¼ (<span id="scenesCount">0</span>ê°œ)</div>
                <div class="results-actions">
                    <button class="btn-icon" onclick="generateAllImages()" id="batchImageBtn" disabled>
                        ğŸ–¼ï¸ ì „ì²´ ì´ë¯¸ì§€ ìƒì„±
                    </button>
                    <button class="btn-icon" onclick="downloadAll()">ğŸ“¥ ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
                </div>
            </div>

            <!-- ì¥ë©´ ê²°ê³¼ ëª©ë¡ -->
            <div id="sceneResultsList">
                <div style="text-align:center;padding:3rem;color:var(--text-muted)">
                    <div style="font-size:3rem;margin-bottom:1rem">ğŸ“</div>
                    <div>M-06 JSON íŒŒì¼ì„ ê°€ì ¸ì™€ì„œ ì‹œì‘í•˜ì„¸ìš”</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ (Lightbox) -->
    <div class="image-lightbox" id="imageLightbox" onclick="closeLightbox(event)">
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
            <button class="lightbox-nav prev" onclick="navigateLightbox(-1)">â®</button>
            <img id="lightboxImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
            <button class="lightbox-nav next" onclick="navigateLightbox(1)">â¯</button>
            <div class="lightbox-info">
                <span id="lightboxLabel" style="color:white;font-size:0.9rem;"></span>
            </div>
            <div style="display:flex;justify-content:center;gap:0.75rem;margin-top:1rem;">
                <button class="lightbox-btn" onclick="downloadCurrentImage()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                <button class="lightbox-btn secondary" onclick="regenerateCurrentImage()">ğŸ”„ ì¬ìƒì„±</button>
            </div>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal" style="max-width:600px">
            <div class="modal-header">
                <div class="modal-title">âš™ï¸ API ì„¤ì •</div>
                <button class="modal-close" onclick="closeSettingsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="font-size:0.75rem;color:var(--text-muted);margin-bottom:1rem">ì´ë¯¸ì§€ ìƒì„± ë° í”„ë¡¬í”„íŠ¸ ë³€í™˜ì— ì‚¬ìš©í•  API í‚¤ë¥¼
                    ì„¤ì •í•˜ì„¸ìš”.</p>

                <!-- OpenAI -->
                <div class="api-key-item">
                    <div class="api-key-header">
                        <span class="api-key-name">ğŸ”‘ OpenAI (DALL-E 3, GPT-4o)</span>
                        <span class="api-key-status no" id="openaiStatus">ë¯¸ì—°ê²°</span>
                    </div>
                    <div class="api-key-row">
                        <input type="password" class="api-key-input" id="openaiKey" placeholder="sk-...">
                        <button class="api-key-btn test" onclick="testApiKey('openai')">í…ŒìŠ¤íŠ¸</button>
                    </div>
                </div>

                <!-- Gemini -->
                <div class="api-key-item">
                    <div class="api-key-header">
                        <span class="api-key-name">ğŸ”‘ Google Gemini</span>
                        <span class="api-key-status no" id="geminiStatus">ë¯¸ì—°ê²°</span>
                    </div>
                    <div class="api-key-row">
                        <input type="password" class="api-key-input" id="geminiKey" placeholder="AIzaSy...">
                        <button class="api-key-btn test" onclick="testApiKey('gemini')">í…ŒìŠ¤íŠ¸</button>
                    </div>
                </div>

                <!-- Vertex AI -->
                <div class="api-key-item">
                    <div class="api-key-header">
                        <span class="api-key-name">ğŸ”‘ Vertex AI (Imagen)</span>
                        <span class="api-key-status no" id="vertexStatus">ë¯¸ì—°ê²°</span>
                    </div>
                    <div class="api-key-row">
                        <input type="password" class="api-key-input" id="vertexKey" placeholder="Google Cloud API Key">
                        <button class="api-key-btn test" onclick="testApiKey('vertex')">í…ŒìŠ¤íŠ¸</button>
                    </div>
                    <div style="font-size:0.65rem;color:var(--text-muted);margin-top:0.35rem">* Gemini í‚¤ì™€ ë™ì¼í•˜ê±°ë‚˜ ë³„ë„
                        Vertex AI í‚¤ ì‚¬ìš©</div>
                </div>

                <!-- Replicate -->
                <div class="api-key-item">
                    <div class="api-key-header">
                        <span class="api-key-name">ğŸ”‘ Replicate (Flux)</span>
                        <span class="api-key-status no" id="replicateStatus">ë¯¸ì—°ê²°</span>
                    </div>
                    <div class="api-key-row">
                        <input type="password" class="api-key-input" id="replicateKey" placeholder="r8_...">
                        <button class="api-key-btn test" onclick="testApiKey('replicate')">í…ŒìŠ¤íŠ¸</button>
                    </div>
                </div>

                <!-- Claude -->
                <div class="api-key-item">
                    <div class="api-key-header">
                        <span class="api-key-name">ğŸ”‘ Claude (í”„ë¡¬í”„íŠ¸ ìƒì„±ìš©)</span>
                        <span class="api-key-status no" id="claudeStatus">ë¯¸ì—°ê²°</span>
                    </div>
                    <div class="api-key-row">
                        <input type="password" class="api-key-input" id="claudeKey" placeholder="sk-ant-...">
                        <button class="api-key-btn test" onclick="testApiKey('claude')">í…ŒìŠ¤íŠ¸</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" style="width:auto;margin:0" onclick="closeSettingsModal()">ì·¨ì†Œ</button>
                <button class="btn-generate" style="width:auto;margin:0;padding:0.6rem 1.5rem"
                    onclick="saveApiKeys()">ğŸ’¾ ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- ë””ìì´ë„ˆ ê´€ë¦¬ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="designerModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">ğŸ‘¤ ë””ìì´ë„ˆ ê´€ë¦¬</div>
                <button class="modal-close" onclick="closeDesignerModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" onclick="showDesignerTab('list')">ë””ìì´ë„ˆ ëª©ë¡</div>
                    <div class="tab" onclick="showDesignerTab('create')">ìƒˆ ë””ìì´ë„ˆ</div>
                </div>

                <!-- ëª©ë¡ íƒ­ -->
                <div class="tab-content active" id="designerListTab">
                    <div style="margin-bottom:1rem">
                        <input type="text" class="form-input" id="designerSearch" placeholder="ë””ìì´ë„ˆ ê²€ìƒ‰..."
                            oninput="filterDesigners()">
                    </div>
                    <div id="designerListContent"></div>
                </div>

                <!-- ìƒì„± íƒ­ -->
                <div class="tab-content" id="designerCreateTab">
                    <div class="form-group">
                        <label class="form-label">ë””ìì´ë„ˆ ì´ë¦„</label>
                        <input type="text" class="form-input" id="newDesignerName" placeholder="ì˜ˆ: ë‚´ ë¸Œëœë“œ ìŠ¤íƒ€ì¼">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì„¤ëª…</label>
                        <input type="text" class="form-input" id="newDesignerDesc" placeholder="ì´ ë””ìì´ë„ˆì˜ íŠ¹ì§•">
                    </div>
                    <div class="form-group">
                        <label class="form-label">í”„ë¡¬í”„íŠ¸ ì•ì— ì¶”ê°€ (prefix)</label>
                        <textarea class="prompt-textarea" id="newDesignerPrefix" style="min-height:60px"
                            placeholder="[cinematic lighting, warm atmosphere]"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">í”„ë¡¬í”„íŠ¸ ë’¤ì— ì¶”ê°€ (suffix)</label>
                        <textarea class="prompt-textarea" id="newDesignerSuffix" style="min-height:60px"
                            placeholder="--style cinematic --quality 4K"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë„¤ê±°í‹°ë¸Œ í”„ë¡¬í”„íŠ¸</label>
                        <textarea class="prompt-textarea" id="newDesignerNegative" style="min-height:60px"
                            placeholder="low quality, blurry..."></textarea>
                    </div>
                    <button class="btn-generate" onclick="createDesigner()">âœ¨ ë””ìì´ë„ˆ ìƒì„±</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="imageModal" onclick="closeImageModal()">
        <div class="modal" style="max-width:900px" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="imageModalTitle">ì´ë¯¸ì§€ ìƒì„¸</div>
                <button class="modal-close" onclick="closeImageModal()">Ã—</button>
            </div>
            <div class="modal-body" style="text-align:center">
                <img id="modalImage" style="max-width:100%;border-radius:8px">
                <div id="modalPrompt"
                    style="margin-top:1rem;font-size:0.75rem;color:var(--text-muted);text-align:left;background:var(--dark-panel);padding:1rem;border-radius:8px">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" style="width:auto;margin:0" onclick="regenerateImage()">ğŸ”„ ì¬ìƒì„±</button>
                <button class="btn-generate" style="width:auto;margin:0;padding:0.6rem 1.5rem"
                    onclick="downloadImage()">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // ì „ì—­ ìƒíƒœ
        // ============================================
        let scenes = [];
        let designers = {};
        let selectedSceneId = null;
        let selectedDesignerId = 'bright_cheerful';
        let generatedImages = [];
        let currentCategory = 'all';
        let isSynced = true;
        let categoryGroups = {};  // ì¹´í…Œê³ ë¦¬ ê·¸ë£¹ ì •ë³´
        let favorites = [];  // ì¦ê²¨ì°¾ê¸° ëª©ë¡
        let thumbnails = [];  // ì¸ë„¤ì¼ ë°ì´í„°
        let fullScript = '';  // ì „ì²´ ëŒ€ë³¸
        let projectTitle = '';  // í”„ë¡œì íŠ¸ ì œëª©

        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        document.addEventListener('DOMContentLoaded', function () {
            loadDesigners();
            loadApiStatus();
            setupImportArea();
        });

        async function loadDesigners() {
            try {
                const res = await fetch('/api/designers');
                const data = await res.json();
                designers = { ...data.presets, ...data.custom };
                categoryGroups = data.category_groups || {};
                favorites = data.favorites || [];

                // ì¹´í…Œê³ ë¦¬ íƒ­ ë™ì  ìƒì„±
                renderCategoryTabs();
                renderDesignerGrid();
                renderDesignerList();
            } catch (e) {
                console.error('ë””ìì´ë„ˆ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }

        // ì¹´í…Œê³ ë¦¬ íƒ­ ë™ì  ìƒì„±
        function renderCategoryTabs() {
            const tabsContainer = document.querySelector('.designer-tabs');
            if (!tabsContainer) return;

            let html = '<button class="designer-tab active" onclick="showDesignerCategory(\'all\')">ì „ì²´</button>';

            // ì¹´í…Œê³ ë¦¬ ê·¸ë£¹ë³„ íƒ­
            const groupOrder = ['video', 'photo', 'art', 'cartoon', 'design', 'special'];
            for (const groupId of groupOrder) {
                const group = categoryGroups[groupId];
                if (group) {
                    html += '<button class="designer-tab" onclick="showDesignerCategory(\'' + groupId + '\')">' + group.name + '</button>';
                }
            }

            // ì¦ê²¨ì°¾ê¸° íƒ­
            html += '<button class="designer-tab" onclick="showDesignerCategory(\'favorites\')">â­ ì¦ê²¨ì°¾ê¸°</button>';
            // ì»¤ìŠ¤í…€ íƒ­
            html += '<button class="designer-tab" onclick="showDesignerCategory(\'custom\')">ğŸ¨ ë‚´ ë””ìì´ë„ˆ</button>';

            tabsContainer.innerHTML = html;
        }

        async function loadApiStatus() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                let connectedCount = 0;

                for (const [provider, info] of Object.entries(data.api_keys)) {
                    const statusEl = document.getElementById(provider + 'Status');
                    if (statusEl && info.configured) {
                        statusEl.textContent = 'ì—°ê²°ë¨';
                        statusEl.className = 'api-key-status ok';
                        connectedCount++;
                    }
                }

                const badge = document.getElementById('apiStatusBadge');
                const text = document.getElementById('apiStatusText');
                if (connectedCount > 0) {
                    badge.className = 'api-status ok';
                    text.textContent = connectedCount + 'ê°œ ì—°ê²°ë¨';
                }
            } catch (e) {
                console.error('API ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', e);
            }
        }

        // ============================================
        // ë””ìì´ë„ˆ ê·¸ë¦¬ë“œ
        // ============================================
        function renderDesignerGrid() {
            const grid = document.getElementById('designerGrid');
            let html = '';
            let count = 0;

            for (const id in designers) {
                const d = designers[id];
                const designerCategory = d.category || 'video';

                // ì¹´í…Œê³ ë¦¬ í•„í„°ë§
                let show = false;
                if (currentCategory === 'all') {
                    show = true;
                } else if (currentCategory === 'favorites') {
                    show = favorites.includes(id) || d.is_favorite;
                } else if (currentCategory === 'custom') {
                    show = !d.is_preset;
                } else {
                    // ì¹´í…Œê³ ë¦¬ ê·¸ë£¹ í•„í„°ë§
                    const group = categoryGroups[currentCategory];
                    if (group && group.categories) {
                        show = group.categories.includes(designerCategory);
                    }
                }

                if (!show) continue;
                count++;

                const isActive = id === selectedDesignerId ? 'active' : '';
                const isFavorite = favorites.includes(id) || d.is_favorite;
                const icon = d.name.split(' ')[0];
                const name = d.name.replace(/^[^\s]+\s/, '');

                html += '<div class="designer-card ' + isActive + '">' +
                    '<div class="designer-card-inner" onclick="selectDesigner(\'' + id + '\')">' +
                    '<div class="designer-icon">' + icon + '</div>' +
                    '<div class="designer-name">' + name + '</div>' +
                    '<span class="category-badge">' + (designerCategory) + '</span>' +
                    '</div>' +
                    '<button class="favorite-btn ' + (isFavorite ? 'active' : '') + '" onclick="event.stopPropagation();toggleFavorite(\'' + id + '\')" title="ì¦ê²¨ì°¾ê¸°">' +
                    (isFavorite ? 'â­' : 'â˜†') +
                    '</button>' +
                    '</div>';
            }

            grid.innerHTML = html || '<div style="color:var(--text-muted);font-size:0.75rem;grid-column:1/-1;text-align:center;padding:2rem">í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ë””ìì´ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        }

        function showDesignerCategory(category) {
            currentCategory = category;

            // íƒ­ í™œì„±í™”
            document.querySelectorAll('.designer-tab').forEach(tab => tab.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }

            renderDesignerGrid();
        }

        // ì¦ê²¨ì°¾ê¸° í† ê¸€
        async function toggleFavorite(designerId) {
            try {
                const res = await fetch('/api/designers/' + designerId + '/favorite', {
                    method: 'POST'
                });
                const data = await res.json();

                if (data.success) {
                    // ì¦ê²¨ì°¾ê¸° ëª©ë¡ ì—…ë°ì´íŠ¸
                    if (data.is_favorite) {
                        if (!favorites.includes(designerId)) favorites.push(designerId);
                    } else {
                        favorites = favorites.filter(f => f !== designerId);
                    }

                    // ë””ìì´ë„ˆ ê°ì²´ ì—…ë°ì´íŠ¸
                    if (designers[designerId]) {
                        designers[designerId].is_favorite = data.is_favorite;
                    }

                    renderDesignerGrid();
                    showToast(data.message);
                }
            } catch (e) {
                showToast('ì¦ê²¨ì°¾ê¸° ì²˜ë¦¬ ì‹¤íŒ¨', 'error');
            }
        }

        function selectDesigner(id) {
            selectedDesignerId = id;
            renderDesignerGrid();

            const d = designers[id];
            if (d) {
                // í”„ë¡¬í”„íŠ¸ì— ë””ìì´ë„ˆ ìŠ¤íƒ€ì¼ ì ìš© (ê¸°ë³¸ í…œí”Œë¦¿)
                const currentEn = document.getElementById('promptEn').value;
                if (!currentEn || currentEn.includes('description') || currentEn.includes('your scene')) {
                    // êµ¬ì¡°í™”ëœ íƒœê·¸ í˜•ì‹ í…œí”Œë¦¿
                    const styleTag = '[' + (d.name.replace(/^[^\s]+\s/, '')) + ' Style]';
                    document.getElementById('promptEn').value = styleTag + ' [Context: ] ' + d.prompt_prefix.trim() + ' your scene description here ' + d.prompt_suffix;
                }
                document.getElementById('promptNegative').value = d.negative_prompt || '';
                showToast(d.name + ' ì„ íƒë¨');
            }
        }

        // ============================================
        // AI ë””ìì´ë„ˆ ì¶”ì²œ
        // ============================================
        async function getAIRecommendation() {
            const input = document.getElementById('recommendInput').value.trim();

            // ì¥ë©´ì´ ë¡œë“œë˜ì–´ ìˆìœ¼ë©´ ëŒ€ë³¸ ë¶„ì„ ëª¨ë“œ
            const hasScenes = scenes.length > 0;

            if (!input && !hasScenes) {
                showToast('ì„¤ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜ ì¥ë©´ì„ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”', 'error');
                return;
            }

            const resultBox = document.getElementById('recommendResult');
            resultBox.classList.add('show');

            const modeText = hasScenes ? 'ëŒ€ë³¸ ë¶„ì„ ì¤‘...' : 'ë¶„ì„ ì¤‘...';
            document.getElementById('recommendedDesigner').innerHTML = '<span class="spinner"></span> ' + modeText;
            document.getElementById('recommendReason').textContent = '';

            try {
                // ì¥ë©´ ë°ì´í„° í¬í•¨í•˜ì—¬ ìš”ì²­
                const requestBody = {
                    description: input || (hasScenes ? 'ëŒ€ë³¸ ê¸°ë°˜ ì¶”ì²œ' : ''),
                    scenes: hasScenes ? scenes : null,
                    ai_provider: document.getElementById('promptAI').value
                };

                const res = await fetch('/api/designers/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await res.json();

                if (data.success && data.recommended) {
                    const designer = designers[data.recommended];
                    const name = designer ? designer.name : data.recommended;

                    // ëŒ€ë³¸ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                    let analysisHtml = '';
                    if (data.script_analyzed && data.analysis) {
                        analysisHtml = '<div style="margin-bottom:0.5rem;padding:0.5rem;background:var(--dark-panel);border-radius:6px;font-size:0.7rem">' +
                            '<span style="color:var(--purple)">ğŸ“Š ëŒ€ë³¸ ë¶„ì„:</span> ' + escapeHtml(data.analysis) +
                            '</div>';
                    }

                    document.getElementById('recommendedDesigner').innerHTML =
                        analysisHtml +
                        '<span style="font-size:1.25rem">' + name + '</span>' +
                        '<button class="btn-icon" style="margin-left:0.5rem;padding:0.25rem 0.5rem;font-size:0.7rem" onclick="selectDesigner(\'' + data.recommended + '\')">ì ìš©</button>';

                    // í•œê¸€ ì¶”ì²œ ì´ìœ  ìš°ì„ 
                    const reason = data.reason_ko || data.reason || '';
                    document.getElementById('recommendReason').innerHTML = escapeHtml(reason);

                    // ëŒ€ì•ˆë„ í‘œì‹œ
                    if (data.alternatives && data.alternatives.length > 0) {
                        let altHtml = '<div style="margin-top:0.5rem;font-size:0.7rem;color:var(--text-muted)">ëŒ€ì•ˆ: ';
                        data.alternatives.forEach(alt => {
                            const altD = designers[alt];
                            if (altD) {
                                altHtml += '<span style="cursor:pointer;text-decoration:underline" onclick="selectDesigner(\'' + alt + '\')">' + altD.name.split(' ')[0] + '</span> ';
                            }
                        });
                        altHtml += '</div>';
                        document.getElementById('recommendReason').innerHTML += altHtml;
                    }

                    // ëŒ€ë³¸ ë¶„ì„ ì„±ê³µ ì‹œ ì•ˆë‚´
                    if (data.script_analyzed) {
                        showToast('ëŒ€ë³¸ ë¶„ì„ ì™„ë£Œ! ì¶”ì²œ: ' + name);
                    }
                } else {
                    document.getElementById('recommendedDesigner').textContent = 'ì¶”ì²œ ì‹¤íŒ¨';
                    document.getElementById('recommendReason').textContent = data.error || 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”';
                }
            } catch (e) {
                document.getElementById('recommendedDesigner').textContent = 'ì˜¤ë¥˜ ë°œìƒ';
                document.getElementById('recommendReason').textContent = e.message;
            }
        }

        // ============================================
        // í•œê¸€-ì˜ë¬¸ ë™ê¸°í™”
        // ============================================
        let syncTimeout = null;

        function markAsUnsynced() {
            isSynced = false;
            document.getElementById('syncIndicator').className = 'sync-indicator unsynced';
            document.getElementById('syncStatus').textContent = 'ë™ê¸°í™” í•„ìš”';
        }

        async function syncKoToEn() {
            const koText = document.getElementById('promptKo').value.trim();
            if (!koText) {
                showToast('í•œê¸€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            const syncBtn = document.getElementById('syncBtn');
            const spinner = document.getElementById('syncSpinner');
            const indicator = document.getElementById('syncIndicator');

            syncBtn.disabled = true;
            spinner.style.display = 'inline-block';
            indicator.className = 'sync-indicator syncing';
            document.getElementById('syncStatus').textContent = 'ë³€í™˜ ì¤‘...';

            try {
                const promptAI = document.getElementById('promptAI').value;
                const res = await fetch('/api/prompts/sync-ko-to-en', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        korean_text: koText,
                        designer_id: selectedDesignerId,
                        ai_provider: promptAI
                    })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('promptEn').value = data.prompt_en;
                    if (data.negative_prompt) {
                        document.getElementById('promptNegative').value = data.negative_prompt;
                    }
                    isSynced = true;
                    indicator.className = 'sync-indicator';
                    document.getElementById('syncStatus').textContent = 'ë™ê¸°í™”ë¨';
                    showToast('ì˜ë¬¸ ë³€í™˜ ì™„ë£Œ!');
                } else {
                    throw new Error(data.error || 'ë³€í™˜ ì‹¤íŒ¨');
                }
            } catch (e) {
                indicator.className = 'sync-indicator unsynced';
                document.getElementById('syncStatus').textContent = 'ë³€í™˜ ì‹¤íŒ¨';
                showToast('ë³€í™˜ ì‹¤íŒ¨: ' + e.message, 'error');
            } finally {
                syncBtn.disabled = false;
                spinner.style.display = 'none';
            }
        }

        function addTag(tag) {
            const textarea = document.getElementById('promptEn');
            const cursorPos = textarea.selectionStart;
            const before = textarea.value.substring(0, cursorPos);
            const after = textarea.value.substring(cursorPos);
            textarea.value = before + tag + after;
            textarea.focus();
            textarea.setSelectionRange(cursorPos + tag.length, cursorPos + tag.length);
        }

        // ============================================
        // ì¥ë©´ ê´€ë¦¬
        // ============================================
        function setupImportArea() {
            const area = document.getElementById('importArea');
            area.onclick = () => document.getElementById('fileInput').click();
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('importArea').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('importArea').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('importArea').classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.json')) {
                processFile(file);
            } else {
                showToast('JSON íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        async function processFile(file) {
            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (data.scenes && Array.isArray(data.scenes)) {
                    scenes = data.scenes.map((s, i) => ({
                        ...s,
                        scene_id: s.scene_id || i + 1,
                        prompt_ko: '',
                        prompt_en: '',
                        image_url: null,
                        status: 'pending'  // pending, prompt_ready, generating, completed
                    }));

                    // ì „ì²´ ëŒ€ë³¸ ì €ì¥ (ì¸ë„¤ì¼ ìƒì„±ìš©)
                    fullScript = scenes.map(s => s.script_text || '').join('\n');
                    projectTitle = data.title || file.name.replace('.json', '');

                    // ì¥ë©´ ìˆ˜ ì—…ë°ì´íŠ¸
                    document.getElementById('scenesCount').textContent = scenes.length;

                    // ì¸ë„¤ì¼ ì„¹ì…˜ í‘œì‹œ
                    document.getElementById('thumbnailSection').style.display = 'block';

                    // ìƒˆë¡œìš´ ê²°ê³¼ ëª©ë¡ ë Œë”ë§
                    renderSceneResults();

                    showToast(scenes.length + 'ê°œ ì¥ë©´ ë¡œë“œë¨ - í”„ë¡¬í”„íŠ¸ ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”');
                } else {
                    showToast('ì˜¬ë°”ë¥¸ M-06 JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤', 'error');
                }
            } catch (e) {
                showToast('íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨: ' + e.message, 'error');
            }
        }

        // ============================================
        // ì¥ë©´ ê²°ê³¼ ë Œë”ë§ (ìƒˆë¡œìš´ ë ˆì´ì•„ì›ƒ)
        // ============================================
        function renderSceneResults() {
            const container = document.getElementById('sceneResultsList');
            if (!container) return;

            if (scenes.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:3rem;color:var(--text-muted)">' +
                    '<div style="font-size:3rem;margin-bottom:1rem">ğŸ“</div>' +
                    '<div>M-06 JSON íŒŒì¼ì„ ê°€ì ¸ì™€ì„œ ì‹œì‘í•˜ì„¸ìš”</div>' +
                    '</div>';
                return;
            }

            let html = '';
            let allPromptsReady = true;

            scenes.forEach((scene, index) => {
                const statusClass = scene.status === 'completed' ? 'completed' :
                    scene.status === 'generating' ? 'generating' : '';

                if (scene.status === 'pending') allPromptsReady = false;

                html += '<div class="scene-result-card ' + statusClass + '" data-scene-id="' + scene.scene_id + '">';

                // ì™¼ìª½: ëŒ€ë³¸
                html += '<div class="scene-script-col">' +
                    '<div class="scene-script-header">' +
                    '<span class="scene-number">ì¥ë©´ ' + scene.scene_id + '</span>' +
                    '</div>' +
                    '<div class="script-text">' + escapeHtml(scene.script_text || '') + '</div>' +
                    '</div>';

                // ì¤‘ì•™: í”„ë¡¬í”„íŠ¸
                html += '<div class="scene-prompt-col">';
                if (scene.prompt_ko || scene.prompt_en) {
                    // í•œê¸€ ì„¤ëª… (ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì„¤ëª…) - í¸ì§‘ ê°€ëŠ¥
                    html += '<div class="prompt-section">' +
                        '<div class="prompt-label">' +
                        'ğŸ‡°ğŸ‡· ì´ë¯¸ì§€ í•œê¸€ ì„¤ëª… ' +
                        '<span style="font-size:0.55rem;color:var(--info);">(í¸ì§‘í•˜ë©´ ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ ìë™ ë™ê¸°í™”)</span>' +
                        '</div>' +
                        '<textarea class="prompt-ko-edit" data-scene-index="' + index + '" ' +
                        'onblur="syncSceneKoToEn(' + index + ')" ' +
                        'style="width:100%;min-height:60px;padding:0.5rem;background:rgba(34,197,94,0.05);' +
                        'border:1px solid var(--dark-border);border-radius:6px;color:var(--success);' +
                        'font-size:0.8rem;resize:vertical;font-family:inherit;line-height:1.4;"' +
                        '>' + escapeHtml(scene.prompt_ko || '(ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”)') + '</textarea>' +
                        '</div>' +
                        '<div class="prompt-section">' +
                        '<div class="prompt-label">ğŸŒ ì´ë¯¸ì§€ ìƒì„±ìš© ì˜ë¬¸ í”„ë¡¬í”„íŠ¸</div>' +
                        '<div class="prompt-en-text">' + escapeHtml(scene.prompt_en || '') + '</div>' +
                        '</div>';
                } else {
                    html += '<div style="color:var(--text-muted);font-size:0.8rem;padding:1rem;text-align:center">' +
                        'ğŸ“ í”„ë¡¬í”„íŠ¸ ìƒì„± ëŒ€ê¸° ì¤‘...' +
                        '</div>';
                }
                html += '</div>';

                // ì˜¤ë¥¸ìª½: ì´ë¯¸ì§€
                const hasImage = !!scene.image_url;
                html += '<div class="scene-image-col">' +
                    '<div class="image-preview ' + (hasImage ? '' : 'no-image') + '" ' +
                    (hasImage ? 'onclick="openLightbox(' + index + ')"' : '') + '>';
                if (hasImage) {
                    html += '<img src="' + scene.image_url + '" alt="ì¥ë©´ ' + scene.scene_id + '">';
                } else {
                    html += '<div class="image-placeholder">ì´ë¯¸ì§€ ì—†ìŒ</div>';
                }
                html += '</div>' +
                    '<div class="image-actions">' +
                    '<button class="btn-generate-single" onclick="event.stopPropagation();generateSingleImage(' + index + ')" ' +
                    (scene.prompt_en ? '' : 'disabled') + ' title="ì´ë¯¸ì§€ ìƒì„±">ğŸ–¼ï¸</button>' +
                    '<button class="btn-regenerate" onclick="event.stopPropagation();regenerateImage(' + index + ')" ' +
                    (hasImage ? '' : 'disabled') + ' title="ì¬ìƒì„±">ğŸ”„</button>' +
                    '<button class="btn-zoom" onclick="event.stopPropagation();openLightbox(' + index + ')" ' +
                    (hasImage ? '' : 'disabled') + ' title="í™•ëŒ€">ğŸ”</button>' +
                    '<button class="btn-download-single" onclick="event.stopPropagation();downloadSingleImage(' + index + ')" ' +
                    (hasImage ? '' : 'disabled') + ' title="ë‹¤ìš´ë¡œë“œ">ğŸ“¥</button>' +
                    '</div>' +
                    '</div>';

                html += '</div>';
            });

            container.innerHTML = html;

            // ëª¨ë“  í”„ë¡¬í”„íŠ¸ê°€ ì¤€ë¹„ë˜ë©´ ì „ì²´ ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ í™œì„±í™”
            const batchImageBtn = document.getElementById('batchImageBtn');
            if (batchImageBtn) {
                batchImageBtn.disabled = !allPromptsReady || scenes.every(s => s.status === 'pending');
            }
        }

        // í•œê¸€ ì„¤ëª… í¸ì§‘ ì‹œ ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ ë™ê¸°í™”
        async function syncSceneKoToEn(index) {
            const scene = scenes[index];
            if (!scene) return;

            const textarea = document.querySelector('.prompt-ko-edit[data-scene-index="' + index + '"]');
            if (!textarea) return;

            const newKoText = textarea.value.trim();

            // ë³€ê²½ ì—†ìœ¼ë©´ ë¬´ì‹œ
            if (newKoText === scene.prompt_ko) return;

            // ë¹ˆ ê°’ì´ë©´ ë¬´ì‹œ
            if (!newKoText || newKoText === '(ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”)') return;

            // í•œê¸€ ì„¤ëª… ì—…ë°ì´íŠ¸
            scenes[index].prompt_ko = newKoText;

            // ë¡œë”© í‘œì‹œ
            const promptEnDiv = textarea.closest('.scene-prompt-col').querySelector('.prompt-en-text');
            if (promptEnDiv) {
                promptEnDiv.innerHTML = '<span class="spinner" style="width:14px;height:14px;"></span> ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ ë™ê¸°í™” ì¤‘...';
            }

            try {
                const provider = document.getElementById('promptAI').value;
                const res = await fetch('/api/prompts/sync-ko-to-en', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        korean_text: newKoText,
                        designer_id: selectedDesignerId,
                        ai_provider: provider
                    })
                });
                const data = await res.json();

                if (data.success && data.prompt_en) {
                    scenes[index].prompt_en = data.prompt_en;
                    if (promptEnDiv) {
                        promptEnDiv.textContent = data.prompt_en;
                    }
                    showToast('ì¥ë©´ ' + scene.scene_id + ' ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ ë™ê¸°í™” ì™„ë£Œ');
                } else {
                    if (promptEnDiv) {
                        promptEnDiv.textContent = scene.prompt_en || 'ë™ê¸°í™” ì‹¤íŒ¨';
                    }
                    showToast('ë™ê¸°í™” ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (e) {
                if (promptEnDiv) {
                    promptEnDiv.textContent = scene.prompt_en || 'ë™ê¸°í™” ì˜¤ë¥˜';
                }
                showToast('ë™ê¸°í™” ì˜¤ë¥˜: ' + e.message, 'error');
            }
        }

        // ============================================
        // ì „ì²´ í”„ë¡¬í”„íŠ¸ ìƒì„± (ì´ë¯¸ì§€ ìƒì„± ì—†ì´)
        // ============================================
        async function generateAllPrompts() {
            if (scenes.length === 0) {
                showToast('ì¥ë©´ì„ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”', 'error');
                return;
            }

            const btn = document.getElementById('generatePromptsBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘...';
            progressBar.style.display = 'block';

            const provider = document.getElementById('promptAI').value;
            const designer = designers[selectedDesignerId] || designers['bright_cheerful'];

            let completed = 0;
            const total = scenes.length;

            for (let i = 0; i < scenes.length; i++) {
                const scene = scenes[i];

                try {
                    progressText.textContent = 'ì¥ë©´ ' + scene.scene_id + ' í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘... (' + (i + 1) + '/' + total + ')';

                    // í”„ë¡¬í”„íŠ¸ ìƒì„± API í˜¸ì¶œ
                    const res = await fetch('/api/prompts/sync-ko-to-en', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            korean_text: scene.script_text,
                            designer_id: selectedDesignerId,
                            ai_provider: provider
                        })
                    });
                    const data = await res.json();

                    if (data.success) {
                        scenes[i].prompt_ko = data.prompt_ko || scene.script_text;
                        scenes[i].prompt_en = data.prompt_en;
                        scenes[i].negative_prompt = data.negative_prompt;
                        scenes[i].status = 'prompt_ready';
                    } else {
                        scenes[i].prompt_ko = scene.script_text;
                        scenes[i].prompt_en = 'Error: ' + (data.error || 'Unknown');
                        scenes[i].status = 'error';
                    }
                } catch (e) {
                    scenes[i].prompt_ko = scene.script_text;
                    scenes[i].prompt_en = 'Error: ' + e.message;
                    scenes[i].status = 'error';
                }

                completed++;
                const progress = (completed / total) * 100;
                progressFill.style.width = progress + '%';

                // ì‹¤ì‹œê°„ UI ì—…ë°ì´íŠ¸
                renderSceneResults();
            }

            btn.disabled = false;
            btn.innerHTML = 'ğŸ“ ì „ì²´ í”„ë¡¬í”„íŠ¸ ìƒì„±';
            progressBar.style.display = 'none';
            progressText.textContent = '';

            // ì „ì²´ ì´ë¯¸ì§€ ìƒì„± ë²„íŠ¼ í™œì„±í™”
            document.getElementById('batchImageBtn').disabled = false;

            showToast('í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ! ì´ì œ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        // ============================================
        // ì „ì²´ ì´ë¯¸ì§€ ìƒì„± (í”„ë¡¬í”„íŠ¸ê°€ ì¤€ë¹„ëœ í›„)
        // ============================================
        async function generateAllImages() {
            const readyScenes = scenes.filter(s => s.prompt_en && s.status !== 'completed');

            if (readyScenes.length === 0) {
                showToast('ìƒì„±í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const btn = document.getElementById('batchImageBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> ì´ë¯¸ì§€ ìƒì„± ì¤‘...';

            const provider = document.getElementById('imageAPI').value;
            const size = document.getElementById('imageSize').value;
            const resolution = document.getElementById('imageResolution').value;

            let completed = 0;

            for (let i = 0; i < scenes.length; i++) {
                const scene = scenes[i];
                if (!scene.prompt_en || scene.status === 'completed') continue;

                scenes[i].status = 'generating';
                renderSceneResults();

                try {
                    const res = await fetch('/api/images/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: scene.prompt_en,
                            negative_prompt: scene.negative_prompt || '',
                            provider: provider,
                            size: size,
                            resolution: resolution
                        })
                    });
                    const data = await res.json();

                    if (data.success && data.image_url) {
                        scenes[i].image_url = data.image_url;
                        scenes[i].status = 'completed';
                    } else {
                        scenes[i].status = 'error';
                        showToast('ì¥ë©´ ' + scene.scene_id + ' ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨', 'error');
                    }
                } catch (e) {
                    scenes[i].status = 'error';
                    showToast('ì¥ë©´ ' + scene.scene_id + ' ì˜¤ë¥˜: ' + e.message, 'error');
                }

                completed++;
                renderSceneResults();
            }

            btn.disabled = false;
            btn.innerHTML = 'ğŸ–¼ï¸ ì „ì²´ ì´ë¯¸ì§€ ìƒì„±';

            showToast('ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!');
        }

        // ê°œë³„ ì´ë¯¸ì§€ ìƒì„±
        async function generateSingleImage(index) {
            const scene = scenes[index];
            if (!scene || !scene.prompt_en) {
                showToast('í”„ë¡¬í”„íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”', 'error');
                return;
            }

            scenes[index].status = 'generating';
            renderSceneResults();

            const provider = document.getElementById('imageAPI').value;
            const size = document.getElementById('imageSize').value;
            const resolution = document.getElementById('imageResolution').value;

            try {
                const res = await fetch('/api/images/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: scene.prompt_en,
                        negative_prompt: scene.negative_prompt || '',
                        provider: provider,
                        size: size,
                        resolution: resolution
                    })
                });
                const data = await res.json();

                if (data.success && data.image_url) {
                    scenes[index].image_url = data.image_url;
                    scenes[index].status = 'completed';
                    showToast('ì¥ë©´ ' + scene.scene_id + ' ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ');
                } else {
                    scenes[index].status = 'prompt_ready';
                    showToast('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (e) {
                scenes[index].status = 'prompt_ready';
                showToast('ì˜¤ë¥˜: ' + e.message, 'error');
            }

            renderSceneResults();
        }

        // ì´ë¯¸ì§€ ì¬ìƒì„±
        async function regenerateImage(index) {
            await generateSingleImage(index);
        }

        function renderScenesList() {
            const container = document.getElementById('scenesList');
            let html = '';

            scenes.forEach((scene, index) => {
                const isActive = scene.scene_id === selectedSceneId ? 'active' : '';
                const status = scene.image_url ? 'completed' : 'ready';
                const statusText = scene.image_url ? 'ì™„ë£Œ' : 'ëŒ€ê¸°';

                html += '<div class="scene-card ' + isActive + '" onclick="selectScene(' + scene.scene_id + ')">' +
                    '<div class="scene-header">' +
                    '<span class="scene-id">ì¥ë©´ ' + scene.scene_id + '</span>' +
                    '<span class="scene-status ' + status + '">' + statusText + '</span>' +
                    '</div>' +
                    '<div class="scene-text">' + escapeHtml(scene.script_text || '') + '</div>' +
                    '<div class="scene-keywords">';

                if (scene.keywords && scene.keywords.length > 0) {
                    scene.keywords.slice(0, 3).forEach(kw => {
                        html += '<span class="scene-keyword">' + escapeHtml(kw) + '</span>';
                    });
                }

                html += '</div></div>';
            });

            container.innerHTML = html || '<div style="color:var(--text-muted);font-size:0.75rem;text-align:center;padding:2rem">ì¥ë©´ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }

        function selectScene(sceneId) {
            selectedSceneId = sceneId;
            renderScenesList();

            const scene = scenes.find(s => s.scene_id === sceneId);
            if (scene) {
                // í•œê¸€ ì„¤ëª…ì— ëŒ€ë³¸ í…ìŠ¤íŠ¸ ë„£ê¸°
                document.getElementById('promptKo').value = scene.script_text || '';
                markAsUnsynced();
            }
        }

        function addManualScene() {
            const newId = scenes.length > 0 ? Math.max(...scenes.map(s => s.scene_id)) + 1 : 1;
            scenes.push({
                scene_id: newId,
                script_text: 'ìƒˆ ì¥ë©´ ì„¤ëª…',
                keywords: [],
                emotion: 'neutral'
            });
            renderScenesList();
            selectScene(newId);
            showToast('ì¥ë©´ ì¶”ê°€ë¨');
        }

        // ============================================
        // ì´ë¯¸ì§€ ìƒì„±
        // ============================================
        async function generateImages() {
            const promptEn = document.getElementById('promptEn').value.trim();
            if (!promptEn) {
                showToast('ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> ìƒì„± ì¤‘...';

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressBar.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'ì´ë¯¸ì§€ ìƒì„± ì¤‘...';

            try {
                const provider = document.getElementById('imageAPI').value;
                const size = document.getElementById('imageSize').value;
                const negativePrompt = document.getElementById('promptNegative').value;

                const res = await fetch('/api/images/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt_en: promptEn,
                        negative_prompt: negativePrompt,
                        provider: provider,
                        size: size
                    })
                });

                const data = await res.json();
                progressFill.style.width = '100%';

                if (data.success && data.image_url) {
                    generatedImages.push({
                        scene_id: selectedSceneId,
                        image_url: data.image_url,
                        prompt: promptEn
                    });
                    renderGallery();
                    progressText.textContent = 'âœ… ìƒì„± ì™„ë£Œ!';
                    showToast('ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!');

                    // ì¥ë©´ì— ì´ë¯¸ì§€ URL ì €ì¥
                    if (selectedSceneId) {
                        const scene = scenes.find(s => s.scene_id === selectedSceneId);
                        if (scene) {
                            scene.image_url = data.image_url;
                            renderScenesList();
                        }
                    }
                } else {
                    throw new Error(data.error || 'ìƒì„± ì‹¤íŒ¨');
                }
            } catch (e) {
                progressText.textContent = 'âŒ ' + e.message;
                showToast('ìƒì„± ì‹¤íŒ¨: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ¨ ì´ë¯¸ì§€ ìƒì„±';
                setTimeout(() => { progressBar.style.display = 'none'; }, 3000);
            }
        }

        async function generateBatch() {
            if (scenes.length === 0) {
                showToast('ì¥ë©´ì„ ë¨¼ì € ë¡œë“œí•˜ì„¸ìš”', 'error');
                return;
            }

            const btn = document.querySelector('.btn-secondary');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> ë°°ì¹˜ ìƒì„± ì¤‘...';

            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressBar.style.display = 'block';

            // ë°°ì¹˜ ê²°ê³¼ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ë° í‘œì‹œ
            const batchContainer = document.getElementById('batchResultsContainer');
            const batchList = document.getElementById('batchResultsList');
            batchContainer.style.display = 'block';
            batchList.innerHTML = '';

            // ë°°ì¹˜ ê²°ê³¼ ì €ì¥ ë°°ì—´
            let batchResults = [];

            let completed = 0;
            const total = scenes.length;

            for (const scene of scenes) {
                // ì´ë¯¸ ì´ë¯¸ì§€ê°€ ìˆëŠ” ì¥ë©´ì€ ê±´ë„ˆë›°ë˜ ê²°ê³¼ì—ëŠ” í‘œì‹œ
                if (scene.image_url) {
                    batchResults.push({
                        scene_id: scene.scene_id,
                        script_text: scene.script_text,
                        prompt_ko: scene.script_text,
                        prompt_en: '(ê¸°ì¡´ ì´ë¯¸ì§€ ìˆìŒ)',
                        status: 'skip',
                        image_url: scene.image_url
                    });
                    completed++;
                    renderBatchResults(batchResults);
                    continue;
                }

                progressFill.style.width = ((completed / total) * 100) + '%';
                progressText.textContent = 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì¤‘: ' + (completed + 1) + '/' + total;

                // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ í•­ëª© í‘œì‹œ
                const pendingItem = {
                    scene_id: scene.scene_id,
                    script_text: scene.script_text,
                    prompt_ko: scene.script_text,
                    prompt_en: 'ìƒì„± ì¤‘...',
                    status: 'pending'
                };
                batchResults.push(pendingItem);
                renderBatchResults(batchResults);

                try {
                    // í”„ë¡¬í”„íŠ¸ ìƒì„± (AI ì‚¬ìš©)
                    const promptRes = await fetch('/api/prompts/generate-ai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            scenes: [scene],
                            designer_id: selectedDesignerId,
                            ai_provider: document.getElementById('promptAI').value
                        })
                    });
                    const promptData = await promptRes.json();

                    if (promptData.success && promptData.prompts && promptData.prompts[0]) {
                        const prompt = promptData.prompts[0];

                        // ê²°ê³¼ ì—…ë°ì´íŠ¸ (í”„ë¡¬í”„íŠ¸ ìƒì„± ì„±ê³µ)
                        const resultIndex = batchResults.length - 1;
                        batchResults[resultIndex] = {
                            scene_id: scene.scene_id,
                            script_text: scene.script_text,
                            prompt_ko: prompt.prompt_ko || scene.script_text,
                            prompt_en: prompt.prompt_en,
                            negative_prompt: prompt.negative_prompt,
                            status: 'prompt_ready'
                        };
                        renderBatchResults(batchResults);

                        // í•œê¸€ í”„ë¡¬í”„íŠ¸ë„ ì¥ë©´ì— ì €ì¥
                        scene.prompt_ko = prompt.prompt_ko;
                        scene.prompt_en = prompt.prompt_en;

                        progressText.textContent = 'ì´ë¯¸ì§€ ìƒì„± ì¤‘: ' + (completed + 1) + '/' + total;

                        // ì´ë¯¸ì§€ ìƒì„±
                        const imageRes = await fetch('/api/images/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                prompt_en: prompt.prompt_en,
                                negative_prompt: prompt.negative_prompt || '',
                                provider: document.getElementById('imageAPI').value,
                                size: document.getElementById('imageSize').value
                            })
                        });
                        const imageData = await imageRes.json();

                        if (imageData.success) {
                            scene.image_url = imageData.image_url;
                            generatedImages.push({
                                scene_id: scene.scene_id,
                                image_url: imageData.image_url,
                                prompt: prompt.prompt_en,
                                prompt_ko: prompt.prompt_ko
                            });

                            // ê²°ê³¼ ì—…ë°ì´íŠ¸ (ì´ë¯¸ì§€ ìƒì„± ì„±ê³µ)
                            batchResults[resultIndex].status = 'success';
                            batchResults[resultIndex].image_url = imageData.image_url;
                        } else {
                            batchResults[resultIndex].status = 'image_fail';
                            batchResults[resultIndex].error = imageData.error || 'ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨';
                        }
                    } else {
                        // í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹¤íŒ¨
                        const resultIndex = batchResults.length - 1;
                        batchResults[resultIndex].status = 'error';
                        batchResults[resultIndex].error = promptData.error || 'í”„ë¡¬í”„íŠ¸ ìƒì„± ì‹¤íŒ¨';
                    }
                } catch (e) {
                    console.error('Scene ' + scene.scene_id + ' ìƒì„± ì‹¤íŒ¨:', e);
                    const resultIndex = batchResults.length - 1;
                    batchResults[resultIndex].status = 'error';
                    batchResults[resultIndex].error = e.message;
                }

                completed++;
                renderBatchResults(batchResults);
                renderGallery();
                renderScenesList();
            }

            progressFill.style.width = '100%';
            const successCount = batchResults.filter(r => r.status === 'success').length;
            progressText.textContent = 'âœ… ë°°ì¹˜ ìƒì„± ì™„ë£Œ! (ì„±ê³µ: ' + successCount + '/' + total + 'ê°œ)';

            btn.disabled = false;
            btn.innerHTML = 'ğŸ“¦ ì „ì²´ ë°°ì¹˜ ìƒì„±';
            showToast('ë°°ì¹˜ ìƒì„± ì™„ë£Œ! ' + successCount + 'ê°œ ì´ë¯¸ì§€ ìƒì„±ë¨');
        }

        // ë°°ì¹˜ ê²°ê³¼ ë Œë”ë§ í•¨ìˆ˜
        function renderBatchResults(results) {
            const batchList = document.getElementById('batchResultsList');
            let html = '';

            results.forEach(result => {
                let statusClass = 'pending';
                let statusText = 'ëŒ€ê¸° ì¤‘';

                switch (result.status) {
                    case 'pending':
                        statusClass = 'wait';
                        statusText = 'â³ ì²˜ë¦¬ ì¤‘';
                        break;
                    case 'prompt_ready':
                        statusClass = 'wait';
                        statusText = 'ğŸ“ í”„ë¡¬í”„íŠ¸ ìƒì„±ë¨';
                        break;
                    case 'success':
                        statusClass = 'ok';
                        statusText = 'âœ… ì™„ë£Œ';
                        break;
                    case 'skip':
                        statusClass = 'ok';
                        statusText = 'â­ï¸ ê±´ë„ˆëœ€';
                        break;
                    case 'image_fail':
                        statusClass = 'fail';
                        statusText = 'âš ï¸ ì´ë¯¸ì§€ ì‹¤íŒ¨';
                        break;
                    case 'error':
                        statusClass = 'fail';
                        statusText = 'âŒ ì˜¤ë¥˜';
                        break;
                }

                const itemClass = result.status === 'success' || result.status === 'skip' ? 'success' :
                    result.status === 'error' || result.status === 'image_fail' ? 'error' : 'pending';

                html += '<div class="batch-result-item ' + itemClass + '">' +
                    '<div class="batch-result-header">' +
                    '<span class="batch-result-scene">ì¥ë©´ ' + result.scene_id + '</span>' +
                    '<span class="batch-result-status ' + statusClass + '">' + statusText + '</span>' +
                    '</div>' +
                    '<div class="batch-result-prompt">' +
                    '<div class="ko">ğŸ‡°ğŸ‡· ' + escapeHtml(result.prompt_ko || result.script_text || '') + '</div>' +
                    '<div class="en">ğŸ‡ºğŸ‡¸ ' + escapeHtml(result.prompt_en || '') + '</div>' +
                    '</div>';

                if (result.error) {
                    html += '<div style="color:var(--error);font-size:0.65rem;margin-top:0.25rem">âš ï¸ ' + escapeHtml(result.error) + '</div>';
                }

                html += '</div>';
            });

            batchList.innerHTML = html;
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            batchList.scrollTop = batchList.scrollHeight;
        }

        // ë°°ì¹˜ ê²°ê³¼ ë‹«ê¸°
        function clearBatchResults() {
            document.getElementById('batchResultsContainer').style.display = 'none';
        }

        // ============================================
        // ê°¤ëŸ¬ë¦¬
        // ============================================
        function renderGallery() {
            const grid = document.getElementById('galleryGrid');

            if (generatedImages.length === 0) {
                grid.innerHTML = '<div class="gallery-item"><div class="gallery-placeholder">ì´ë¯¸ì§€ ìƒì„± ëŒ€ê¸°ì¤‘</div></div>';
                return;
            }

            let html = '';
            generatedImages.forEach((img, index) => {
                html += '<div class="gallery-item" onclick="openImageModal(' + index + ')">' +
                    '<img src="' + img.image_url + '" alt="Scene ' + (img.scene_id || index + 1) + '">' +
                    '<span class="gallery-badge">ì¥ë©´ ' + (img.scene_id || index + 1) + '</span>' +
                    '<div class="gallery-item-overlay">' +
                    '<button class="btn-icon" style="margin-right:0.25rem">ğŸ”</button>' +
                    '<button class="btn-icon" onclick="event.stopPropagation();downloadSingleImage(' + index + ')">ğŸ“¥</button>' +
                    '</div>' +
                    '</div>';
            });

            grid.innerHTML = html;
        }

        function openImageModal(index) {
            const img = generatedImages[index];
            if (!img) return;

            document.getElementById('modalImage').src = img.image_url;
            document.getElementById('imageModalTitle').textContent = 'ì¥ë©´ ' + (img.scene_id || index + 1);
            document.getElementById('modalPrompt').innerHTML = '<strong>í”„ë¡¬í”„íŠ¸:</strong><br>' + escapeHtml(img.prompt || '');
            document.getElementById('imageModal').classList.add('show');

            document.getElementById('imageModal').dataset.currentIndex = index;
        }

        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('show');
        }

        function downloadImage() {
            const index = document.getElementById('imageModal').dataset.currentIndex;
            downloadSingleImage(index);
        }

        function downloadSingleImage(index) {
            // scenes ë°°ì—´ì—ì„œ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            const scene = scenes[index];
            if (!scene || !scene.image_url) {
                showToast('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            downloadImageFromUrl(scene.image_url, 'scene_' + scene.scene_id + '.png');
            showToast('ì¥ë©´ ' + scene.scene_id + ' ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ');
        }

        function downloadImageFromUrl(url, filename) {
            // Base64 ë°ì´í„° ë˜ëŠ” URL ì²˜ë¦¬
            if (url.startsWith('data:')) {
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                // ì™¸ë¶€ URLì¸ ê²½ìš° fetchë¡œ ë‹¤ìš´ë¡œë“œ
                fetch(url)
                    .then(res => res.blob())
                    .then(blob => {
                        const blobUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(blobUrl);
                    })
                    .catch(err => {
                        // í´ë°±: ìƒˆ íƒ­ì—ì„œ ì—´ê¸°
                        window.open(url, '_blank');
                    });
            }
        }

        function downloadAll() {
            const imagesWithUrl = scenes.filter(s => s.image_url);
            if (imagesWithUrl.length === 0) {
                showToast('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            imagesWithUrl.forEach((scene, i) => {
                setTimeout(() => {
                    downloadImageFromUrl(scene.image_url, 'scene_' + scene.scene_id + '.png');
                }, i * 500);
            });

            showToast(imagesWithUrl.length + 'ê°œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹œì‘');
        }

        // ============================================
        // ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ (Lightbox) ê¸°ëŠ¥
        // ============================================
        let currentLightboxIndex = -1;

        function openLightbox(index) {
            const scene = scenes[index];
            if (!scene || !scene.image_url) return;

            currentLightboxIndex = index;
            currentThumbnailIndex = -1;  // ì¥ë©´ ë¼ì´íŠ¸ë°•ìŠ¤ì„ì„ í‘œì‹œ
            const lightbox = document.getElementById('imageLightbox');
            const img = document.getElementById('lightboxImage');
            const label = document.getElementById('lightboxLabel');

            img.src = scene.image_url;
            label.textContent = 'ì¥ë©´ ' + scene.scene_id;
            lightbox.style.display = 'flex';  // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ëª…ì‹œì  ì„¤ì •
            lightbox.classList.add('show');

            // ESC í‚¤ë¡œ ë‹«ê¸°
            document.addEventListener('keydown', handleLightboxKeydown);
        }

        function closeLightbox(event) {
            if (event && event.target && event.target !== event.currentTarget) return;
            const lightbox = document.getElementById('imageLightbox');
            lightbox.style.display = 'none';
            lightbox.classList.remove('show');
            currentLightboxIndex = -1;
            currentThumbnailIndex = -1;
            document.removeEventListener('keydown', handleLightboxKeydown);
        }

        function handleLightboxKeydown(e) {
            if (e.key === 'Escape') {
                closeLightbox();
            } else if (e.key === 'ArrowLeft') {
                navigateLightbox(-1);
            } else if (e.key === 'ArrowRight') {
                navigateLightbox(1);
            }
        }

        function navigateLightbox(direction) {
            if (currentLightboxIndex < 0) return;

            // ì´ë¯¸ì§€ê°€ ìˆëŠ” ì¥ë©´ë§Œ ì°¾ê¸°
            const scenesWithImages = scenes.map((s, i) => ({ ...s, originalIndex: i })).filter(s => s.image_url);
            if (scenesWithImages.length === 0) return;

            // í˜„ì¬ ìœ„ì¹˜ ì°¾ê¸°
            const currentPos = scenesWithImages.findIndex(s => s.originalIndex === currentLightboxIndex);
            if (currentPos < 0) return;

            // ë‹¤ìŒ/ì´ì „ ìœ„ì¹˜ ê³„ì‚°
            let newPos = currentPos + direction;
            if (newPos < 0) newPos = scenesWithImages.length - 1;
            if (newPos >= scenesWithImages.length) newPos = 0;

            openLightbox(scenesWithImages[newPos].originalIndex);
        }

        function downloadCurrentImage() {
            if (currentLightboxIndex >= 0) {
                downloadSingleImage(currentLightboxIndex);
            }
        }

        async function regenerateCurrentImage() {
            if (currentLightboxIndex >= 0) {
                closeLightbox();
                await regenerateImage(currentLightboxIndex);
            }
        }

        function regenerateImageOld() {
            closeImageModal();
            generateImages();
        }

        // ============================================
        // API ì„¤ì • ëª¨ë‹¬
        // ============================================
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('show');
            loadApiStatus();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        async function testApiKey(provider) {
            const inputId = provider + 'Key';
            const statusId = provider + 'Status';
            const key = document.getElementById(inputId).value.trim();

            if (!key) {
                showToast('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            const statusEl = document.getElementById(statusId);
            statusEl.textContent = 'í…ŒìŠ¤íŠ¸ ì¤‘...';
            statusEl.className = 'api-key-status';

            try {
                const res = await fetch('/api/settings/test-api-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: provider, api_key: key })
                });
                const data = await res.json();

                if (data.success) {
                    statusEl.textContent = 'ì—°ê²°ë¨';
                    statusEl.className = 'api-key-status ok';
                    showToast(provider + ' ì—°ê²° ì„±ê³µ!');
                } else {
                    statusEl.textContent = 'ì‹¤íŒ¨';
                    statusEl.className = 'api-key-status no';
                    showToast(data.error || 'ì—°ê²° ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                statusEl.textContent = 'ì˜¤ë¥˜';
                statusEl.className = 'api-key-status no';
                showToast('í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        }

        async function saveApiKeys() {
            const keys = {
                openai: document.getElementById('openaiKey').value.trim(),
                gemini: document.getElementById('geminiKey').value.trim(),
                vertex: document.getElementById('vertexKey').value.trim(),
                replicate: document.getElementById('replicateKey').value.trim(),
                claude: document.getElementById('claudeKey').value.trim()
            };

            try {
                const res = await fetch('/api/settings/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(keys)
                });
                const data = await res.json();

                if (data.success) {
                    showToast('API í‚¤ ì €ì¥ ì™„ë£Œ!');
                    closeSettingsModal();
                    loadApiStatus();
                } else {
                    showToast('ì €ì¥ ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                showToast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        }

        // ============================================
        // ë””ìì´ë„ˆ ëª¨ë‹¬
        // ============================================
        function openDesignerModal() {
            document.getElementById('designerModal').classList.add('show');
            renderDesignerList();
        }

        function closeDesignerModal() {
            document.getElementById('designerModal').classList.remove('show');
        }

        function showDesignerTab(tabName) {
            const tabs = document.querySelectorAll('#designerModal .tab');
            const contents = document.querySelectorAll('#designerModal .tab-content');

            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            if (tabName === 'list') {
                tabs[0].classList.add('active');
                document.getElementById('designerListTab').classList.add('active');
            } else {
                tabs[1].classList.add('active');
                document.getElementById('designerCreateTab').classList.add('active');
            }
        }

        function filterDesigners() {
            const query = document.getElementById('designerSearch').value.toLowerCase();
            const items = document.querySelectorAll('#designerListContent > div > div');

            items.forEach(item => {
                const name = item.querySelector('div')?.textContent?.toLowerCase() || '';
                item.style.display = name.includes(query) ? '' : 'none';
            });
        }

        function renderDesignerList() {
            const content = document.getElementById('designerListContent');
            let html = '<div style="display:grid;gap:0.5rem">';

            // ì¹´í…Œê³ ë¦¬ë³„ ê·¸ë£¹
            const categories = { video: 'ì˜ìƒ', art: 'ì•„íŠ¸', cartoon: 'ë§Œí™”', photo: 'ì‚¬ì§„', special: 'íŠ¹ìˆ˜', custom: 'ì»¤ìŠ¤í…€' };

            for (const [catId, catName] of Object.entries(categories)) {
                const catDesigners = Object.entries(designers).filter(([id, d]) => {
                    if (catId === 'custom') return !d.is_preset;
                    return d.category === catId && d.is_preset;
                });

                if (catDesigners.length === 0) continue;

                html += '<div style="font-size:0.7rem;color:var(--gold);margin-top:0.5rem">' + catName + ' (' + catDesigners.length + ')</div>';

                catDesigners.forEach(([id, d]) => {
                    html += '<div style="background:var(--dark-panel);padding:0.6rem;border-radius:8px;display:flex;justify-content:space-between;align-items:center">' +
                        '<div style="display:flex;align-items:center;gap:0.5rem">' +
                        '<span style="font-size:1.2rem">' + d.name.split(' ')[0] + '</span>' +
                        '<div>' +
                        '<div style="font-weight:500;font-size:0.8rem">' + d.name.replace(/^[^\s]+\s/, '') + '</div>' +
                        '<div style="font-size:0.65rem;color:var(--text-muted)">' + (d.description || '') + '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div style="display:flex;gap:0.25rem">' +
                        '<button class="btn-icon" style="padding:0.2rem 0.5rem;font-size:0.65rem" onclick="selectDesigner(\'' + id + '\');closeDesignerModal()">ì ìš©</button>' +
                        (d.is_preset ? '' : '<button class="btn-icon" style="padding:0.2rem 0.4rem;font-size:0.65rem" onclick="deleteDesigner(\'' + id + '\')">ğŸ—‘ï¸</button>') +
                        '</div>' +
                        '</div>';
                });
            }

            html += '</div>';
            content.innerHTML = html;
        }

        async function createDesigner() {
            const name = document.getElementById('newDesignerName').value.trim();
            const desc = document.getElementById('newDesignerDesc').value.trim();
            const prefix = document.getElementById('newDesignerPrefix').value.trim();
            const suffix = document.getElementById('newDesignerSuffix').value.trim();
            const negative = document.getElementById('newDesignerNegative').value.trim();

            if (!name) {
                showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            try {
                const res = await fetch('/api/designers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        description: desc,
                        prompt_prefix: prefix,
                        prompt_suffix: suffix,
                        negative_prompt: negative,
                        category: 'custom',
                        best_for: []
                    })
                });
                const data = await res.json();

                if (data.success) {
                    showToast('ë””ìì´ë„ˆ ìƒì„± ì™„ë£Œ!');

                    // í¼ ì´ˆê¸°í™”
                    document.getElementById('newDesignerName').value = '';
                    document.getElementById('newDesignerDesc').value = '';
                    document.getElementById('newDesignerPrefix').value = '';
                    document.getElementById('newDesignerSuffix').value = '';
                    document.getElementById('newDesignerNegative').value = '';

                    loadDesigners();
                    showDesignerTab('list');
                } else {
                    showToast('ìƒì„± ì‹¤íŒ¨: ' + (data.detail || ''), 'error');
                }
            } catch (e) {
                showToast('ìƒì„± ì‹¤íŒ¨: ' + e.message, 'error');
            }
        }

        async function deleteDesigner(id) {
            if (!confirm('ì´ ë””ìì´ë„ˆë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const res = await fetch('/api/designers/' + id, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    showToast('ì‚­ì œ ì™„ë£Œ');
                    loadDesigners();
                }
            } catch (e) {
                showToast('ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        }

        // ============================================
        // ìœ í‹¸ë¦¬í‹°
        // ============================================
        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function showToast(msg, type) {
            type = type || 'success';
            const toast = document.getElementById('toast');
            toast.textContent = (type === 'success' ? 'âœ… ' : 'âŒ ') + msg;
            toast.className = 'toast show';
            setTimeout(function () { toast.classList.remove('show'); }, 3000);
        }

        // ============================================
        // ì¸ë„¤ì¼ ê¸°ëŠ¥
        // ============================================
        async function generateThumbnailPrompts() {
            if (!fullScript) {
                showToast('ë¨¼ì € ëŒ€ë³¸ íŒŒì¼ì„ ê°€ì ¸ì˜¤ì„¸ìš”', 'error');
                return;
            }

            const btn = document.getElementById('genThumbnailBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ ìƒì„± ì¤‘...';

            const aiProvider = document.getElementById('thumbnailAI').value;

            try {
                const res = await fetch('/api/thumbnails/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_script: fullScript,
                        title: projectTitle,
                        ai_provider: aiProvider
                    })
                });

                const data = await res.json();

                if (data.success && data.thumbnails) {
                    thumbnails = data.thumbnails;
                    renderThumbnails();
                    document.getElementById('genAllThumbnailImagesBtn').disabled = false;
                    showToast('ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ 3ê°œ ìƒì„± ì™„ë£Œ!');
                } else {
                    showToast('ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (e) {
                showToast('ì¸ë„¤ì¼ ìƒì„± ì˜¤ë¥˜: ' + e.message, 'error');
            }

            btn.disabled = false;
            btn.innerHTML = 'ğŸ“ ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ ìƒì„±';
        }

        function renderThumbnails() {
            const grid = document.getElementById('thumbnailGrid');
            if (!grid) return;

            const imageProviders = [
                { id: 'vertex', name: 'Vertex AI' },
                { id: 'vertex-nano-banana', name: 'Nano Banana (Vertex)' },
                { id: 'vertex-nano-banana-pro', name: 'Nano Banana Pro (Vertex)' },
                { id: 'dalle3', name: 'DALL-E 3' },
                { id: 'replicate', name: 'Flux' },
                { id: 'replicate-seedream', name: 'SeeDream-4' },
                { id: 'replicate-nano-banana', name: 'Nano Banana' },
                { id: 'replicate-nano-banana-pro', name: 'Nano Banana Pro' }
            ];

            let html = '';
            thumbnails.forEach((thumb, idx) => {
                const hasImage = thumb.image_url || thumb.image_data;
                const imageSrc = thumb.image_data ? thumb.image_data : (thumb.image_url || '');

                html += '<div class="thumbnail-card" data-thumb-idx="' + idx + '" style="display:flex;flex-direction:row;gap:0.75rem;padding:0.75rem;">';

                // ì™¼ìª½: ì´ë¯¸ì§€ ì˜ì—­
                html += '<div class="thumbnail-image-container" onclick="openThumbnailLightbox(' + idx + ')" style="flex-shrink:0;width:200px;height:120px;">';
                if (hasImage) {
                    html += '<img src="' + imageSrc + '" alt="ì¸ë„¤ì¼ ' + (idx + 1) + '" style="width:100%;height:100%;object-fit:cover;">';
                } else {
                    html += '<div class="thumbnail-placeholder" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:2rem;background:var(--dark-bg);border-radius:8px;">ğŸ–¼ï¸</div>';
                }
                if (thumb.generating) {
                    html += '<div class="thumbnail-loading">â³ ìƒì„± ì¤‘...</div>';
                }
                html += '</div>';

                // ì˜¤ë¥¸ìª½: ì •ë³´ ì˜ì—­ (í•œê¸€ ì„¤ëª… + ì˜ë¬¸ í”„ë¡¬í”„íŠ¸)
                html += '<div class="thumbnail-info" style="flex:1;display:flex;flex-direction:column;gap:0.5rem;">';

                // ì¸ë„¤ì¼ ë²ˆí˜¸ ë° í•œê¸€ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´
                html += '<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.25rem;">';
                html += '<span style="font-weight:600;color:var(--primary);font-size:0.85rem;">ì¸ë„¤ì¼ ' + (idx + 1) + '</span>';
                html += '<input type="text" class="thumb-korean-text" data-thumb-idx="' + idx + '" ' +
                    'value="' + escapeHtml(thumb.korean_text || '') + '" ' +
                    'placeholder="í•œê¸€ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´" ' +
                    'onchange="updateThumbnailKoreanText(' + idx + ', this.value)" ' +
                    'style="flex:1;padding:0.3rem 0.5rem;background:rgba(245,158,11,0.1);border:1px solid var(--warning);' +
                    'border-radius:4px;color:var(--warning);font-size:0.75rem;font-weight:500;">';
                html += '</div>';

                // í•œê¸€ ì„¤ëª… (ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ì„¤ëª…) - í¸ì§‘ ê°€ëŠ¥
                html += '<div style="margin-bottom:0.25rem;">';
                html += '<div style="font-size:0.65rem;color:var(--text-muted);margin-bottom:0.2rem;">' +
                    'ğŸ‡°ğŸ‡· ì´ë¯¸ì§€ í•œê¸€ ì„¤ëª… <span style="color:var(--info);">(í¸ì§‘í•˜ë©´ ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ ìë™ ë™ê¸°í™”)</span></div>';
                html += '<textarea class="thumb-prompt-ko" data-thumb-idx="' + idx + '" ' +
                    'onblur="syncThumbnailKoToEn(' + idx + ')" ' +
                    'style="width:100%;min-height:40px;padding:0.4rem;background:rgba(34,197,94,0.05);' +
                    'border:1px solid var(--dark-border);border-radius:6px;color:var(--success);' +
                    'font-size:0.75rem;resize:vertical;font-family:inherit;line-height:1.3;"' +
                    '>' + escapeHtml(thumb.prompt_ko || '(ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”)') + '</textarea>';
                html += '</div>';

                // ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ í‘œì‹œ (í™•ì¥ë¨)
                html += '<div>';
                html += '<div style="font-size:0.65rem;color:var(--text-muted);margin-bottom:0.2rem;">ğŸŒ ì´ë¯¸ì§€ ìƒì„±ìš© ì˜ë¬¸ í”„ë¡¬í”„íŠ¸</div>';
                html += '<div class="thumb-prompt-en" data-thumb-idx="' + idx + '" ' +
                    'style="width:100%;min-height:60px;max-height:120px;overflow-y:auto;padding:0.4rem;' +
                    'background:rgba(59,130,246,0.05);border:1px solid var(--dark-border);border-radius:6px;' +
                    'color:var(--text);font-size:0.7rem;line-height:1.4;word-break:break-word;">' +
                    escapeHtml(thumb.prompt_en || '(í”„ë¡¬í”„íŠ¸ ìƒì„± ëŒ€ê¸° ì¤‘)') + '</div>';
                html += '</div>';

                // ì•¡ì…˜ ë²„íŠ¼
                html += '<div class="thumbnail-actions" style="display:flex;gap:0.5rem;align-items:center;margin-top:auto;">';
                html += '<select id="thumbModel' + idx + '" style="flex:1;padding:0.3rem;background:var(--dark-bg);border:1px solid var(--dark-border);border-radius:4px;color:var(--text);font-size:0.7rem;">';
                imageProviders.forEach(p => {
                    html += '<option value="' + p.id + '">' + p.name + '</option>';
                });
                html += '</select>';
                html += '<button onclick="generateThumbnailImage(' + idx + ')" style="padding:0.3rem 0.75rem;font-size:0.7rem;">ğŸ–¼ï¸ ìƒì„±</button>';
                if (hasImage) {
                    html += '<button class="download" onclick="downloadThumbnail(' + idx + ')" style="padding:0.3rem 0.5rem;font-size:0.7rem;">ğŸ“¥</button>';
                }
                html += '</div>';
                html += '</div>';

                html += '</div>';
            });

            grid.innerHTML = html;
        }

        async function generateThumbnailImage(idx) {
            const thumb = thumbnails[idx];
            if (!thumb || !thumb.prompt_en) {
                showToast('ë¨¼ì € ì¸ë„¤ì¼ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”', 'error');
                return;
            }

            const modelSelect = document.getElementById('thumbModel' + idx);
            const provider = modelSelect ? modelSelect.value : 'vertex';

            thumbnails[idx].generating = true;
            renderThumbnails();

            try {
                const res = await fetch('/api/thumbnails/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt_en: thumb.prompt_en,
                        korean_text: thumb.korean_text || '',
                        provider: provider,
                        size: '1792x1024'
                    })
                });

                const data = await res.json();

                thumbnails[idx].generating = false;

                if (data.success) {
                    thumbnails[idx].image_url = data.image_url || null;
                    thumbnails[idx].image_data = data.image_data || null;
                    showToast('ì¸ë„¤ì¼ ' + (idx + 1) + ' ìƒì„± ì™„ë£Œ!');
                } else {
                    showToast('ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (e) {
                thumbnails[idx].generating = false;
                showToast('ì¸ë„¤ì¼ ìƒì„± ì˜¤ë¥˜: ' + e.message, 'error');
            }

            renderThumbnails();
        }

        async function generateAllThumbnailImages() {
            const btn = document.getElementById('genAllThumbnailImagesBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ ìƒì„± ì¤‘...';

            for (let i = 0; i < thumbnails.length; i++) {
                if (!thumbnails[i].image_url && !thumbnails[i].image_data) {
                    await generateThumbnailImage(i);
                }
            }

            btn.disabled = false;
            btn.innerHTML = 'ğŸ–¼ï¸ ì „ì²´ ìƒì„±';
            showToast('ëª¨ë“  ì¸ë„¤ì¼ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ!');
        }

        function downloadThumbnail(idx) {
            const thumb = thumbnails[idx];
            if (!thumb) return;

            const imageSrc = thumb.image_data || thumb.image_url;
            if (!imageSrc) {
                showToast('ë‹¤ìš´ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }

            const filename = 'thumbnail_' + (idx + 1) + '_' + (thumb.korean_text || 'image').replace(/[^ê°€-í£a-zA-Z0-9]/g, '_') + '.png';

            if (imageSrc.startsWith('data:')) {
                // Base64 ì´ë¯¸ì§€
                const link = document.createElement('a');
                link.href = imageSrc;
                link.download = filename;
                link.click();
            } else {
                // URL ì´ë¯¸ì§€
                downloadImageFromUrl(imageSrc, filename);
            }
        }

        // ì¸ë„¤ì¼ í•œê¸€ í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ì—…ë°ì´íŠ¸
        function updateThumbnailKoreanText(idx, value) {
            if (thumbnails[idx]) {
                thumbnails[idx].korean_text = value;
            }
        }

        // ì¸ë„¤ì¼ í•œê¸€ ì„¤ëª… -> ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ ë™ê¸°í™”
        async function syncThumbnailKoToEn(idx) {
            const thumb = thumbnails[idx];
            if (!thumb) return;

            const textarea = document.querySelector('.thumb-prompt-ko[data-thumb-idx="' + idx + '"]');
            if (!textarea) return;

            const newKoText = textarea.value.trim();

            // ë³€ê²½ ì—†ê±°ë‚˜ ë¹ˆ ê°’ì´ë©´ ë¬´ì‹œ
            if (!newKoText || newKoText === '(ì´ë¯¸ì§€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”)') return;
            if (newKoText === thumb.visual_concept || newKoText === thumb.prompt_ko) return;

            // í•œê¸€ ì„¤ëª… ì—…ë°ì´íŠ¸
            thumbnails[idx].visual_concept = newKoText;
            thumbnails[idx].prompt_ko = newKoText;

            // ë¡œë”© í‘œì‹œ
            const promptEnDiv = document.querySelector('.thumb-prompt-en[data-thumb-idx="' + idx + '"]');
            if (promptEnDiv) {
                promptEnDiv.innerHTML = '<span class="spinner" style="width:14px;height:14px;"></span> ì˜ë¬¸ í”„ë¡¬í”„íŠ¸ ë™ê¸°í™” ì¤‘...';
            }

            try {
                const provider = document.getElementById('thumbnailAI').value;
                const res = await fetch('/api/prompts/sync-ko-to-en', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        korean_text: newKoText,
                        ai_provider: provider,
                        context: 'thumbnail'
                    })
                });
                const data = await res.json();

                if (data.success && data.prompt_en) {
                    thumbnails[idx].prompt_en = data.prompt_en;
                    if (promptEnDiv) {
                        promptEnDiv.textContent = data.prompt_en;
                    }
                    showToast('ì¸ë„¤ì¼ ' + (idx + 1) + ' í”„ë¡¬í”„íŠ¸ ë™ê¸°í™” ì™„ë£Œ!');
                } else {
                    if (promptEnDiv) {
                        promptEnDiv.textContent = thumb.prompt_en || '(ë™ê¸°í™” ì‹¤íŒ¨)';
                    }
                    showToast('í”„ë¡¬í”„íŠ¸ ë™ê¸°í™” ì‹¤íŒ¨: ' + (data.error || 'Unknown'), 'error');
                }
            } catch (e) {
                if (promptEnDiv) {
                    promptEnDiv.textContent = thumb.prompt_en || '(ë™ê¸°í™” ì˜¤ë¥˜)';
                }
                showToast('í”„ë¡¬í”„íŠ¸ ë™ê¸°í™” ì˜¤ë¥˜: ' + e.message, 'error');
            }
        }

        function openThumbnailLightbox(idx) {
            const thumb = thumbnails[idx];
            if (!thumb) return;

            const imageSrc = thumb.image_data || thumb.image_url;
            if (!imageSrc) return;

            const lightbox = document.getElementById('imageLightbox');
            const img = document.getElementById('lightboxImage');
            const label = document.getElementById('lightboxLabel');

            img.src = imageSrc;
            label.textContent = 'ì¸ë„¤ì¼ ' + (idx + 1) + ': ' + (thumb.korean_text || '');
            lightbox.style.display = 'flex';

            currentLightboxIndex = -1;  // ì¸ë„¤ì¼ì€ ë³„ë„ ì²˜ë¦¬
            currentThumbnailIndex = idx;
        }

        let currentThumbnailIndex = -1;
    </script>
</body>

</html>