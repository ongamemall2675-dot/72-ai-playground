<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ëŒ€ë³¸ ìƒì„±ê¸° v2.0 | M-06</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--gold:#D4AF37;--dark-bg:#0a0a0a;--dark-surface:#141414;--dark-elevated:#1e1e1e;--dark-border:#2a2a2a;--text:#fff;--text-muted:rgba(255,255,255,0.5);--success:#22c55e;--error:#ef4444;--warning:#f59e0b;}
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Inter',sans-serif;background:var(--dark-bg);color:var(--text);min-height:100vh;}
        .header{background:var(--dark-surface);padding:1rem 2rem;border-bottom:1px solid var(--dark-border);display:flex;justify-content:space-between;align-items:center;}
        .logo{font-size:1.25rem;font-weight:600;background:linear-gradient(135deg,#D4AF37,#FFD700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        .header-btns{display:flex;gap:0.5rem;align-items:center;}
        .container{display:grid;grid-template-columns:400px 1fr 380px;gap:1rem;padding:1rem;height:calc(100vh - 60px);}
        @media(max-width:1400px){.container{grid-template-columns:1fr;}}
        .panel{background:var(--dark-surface);border:1px solid var(--dark-border);border-radius:12px;display:flex;flex-direction:column;overflow:hidden;}
        .panel-header{padding:1rem;border-bottom:1px solid var(--dark-border);font-weight:600;color:var(--gold);display:flex;justify-content:space-between;align-items:center;}
        .panel-body{padding:1rem;overflow-y:auto;flex:1;}
        .form-group{margin-bottom:1rem;}
        .form-label{display:block;font-size:0.75rem;color:var(--text-muted);margin-bottom:0.375rem;text-transform:uppercase;letter-spacing:0.5px;}
        .form-input,.form-select,.form-textarea{width:100%;padding:0.625rem;background:var(--dark-elevated);border:1px solid var(--dark-border);border-radius:8px;color:var(--text);font-family:inherit;font-size:0.875rem;}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--gold);}
        .form-textarea{resize:vertical;min-height:80px;}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;}
        .form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.75rem;}
        .btn{padding:0.625rem 1rem;font-family:inherit;font-weight:600;border-radius:8px;cursor:pointer;border:none;transition:all 0.2s;font-size:0.875rem;}
        .btn-primary{background:linear-gradient(135deg,#D4AF37,#B8860B);color:#000;}
        .btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 15px rgba(212,175,55,0.3);}
        .btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
        .btn-secondary{background:var(--dark-elevated);border:1px solid var(--dark-border);color:var(--text-muted);}
        .btn-secondary:hover{border-color:var(--gold);color:var(--text);}
        .btn-success{background:rgba(34,197,94,0.2);border:1px solid var(--success);color:var(--success);}
        .btn-danger{background:rgba(239,68,68,0.2);border:1px solid var(--error);color:var(--error);}
        .btn-sm{padding:0.375rem 0.75rem;font-size:0.75rem;}
        .btn-full{width:100%;}
        .ai-selector{display:flex;gap:0.5rem;margin-bottom:1rem;}
        .ai-option{flex:1;padding:0.75rem 0.5rem;background:var(--dark-elevated);border:2px solid var(--dark-border);border-radius:8px;cursor:pointer;text-align:center;transition:all 0.2s;}
        .ai-option:hover,.ai-option.selected{border-color:var(--gold);}
        .ai-option.selected{background:rgba(212,175,55,0.1);}
        .ai-option.disabled{opacity:0.4;cursor:not-allowed;}
        .ai-icon{font-size:1.25rem;}
        .ai-name{font-size:0.8rem;font-weight:600;}
        .ai-desc{font-size:0.65rem;color:var(--text-muted);}
        .ai-status{font-size:0.6rem;margin-top:0.25rem;}
        .ai-status.ok{color:var(--success);}
        .ai-status.no{color:var(--error);}
        .script-editor{background:var(--dark-elevated);border-radius:8px;padding:1rem;min-height:400px;line-height:1.8;white-space:pre-wrap;overflow-y:auto;font-size:0.9rem;}
        .script-editor:focus{outline:2px solid var(--gold);}
        .placeholder{text-align:center;padding:3rem;color:var(--text-muted);}
        .scene-card{background:var(--dark-elevated);border-radius:8px;padding:0.75rem;margin-bottom:0.75rem;border:1px solid var(--dark-border);}
        .scene-header{display:flex;justify-content:space-between;margin-bottom:0.5rem;}
        .scene-id{font-weight:600;color:var(--gold);}
        .scene-meta{font-size:0.7rem;color:var(--text-muted);}
        .scene-text{font-size:0.8rem;color:var(--text-muted);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
        .collapsible{background:var(--dark-elevated);border-radius:8px;margin-bottom:0.75rem;border:1px solid var(--dark-border);}
        .collapsible-header{padding:0.75rem;cursor:pointer;display:flex;justify-content:space-between;font-size:0.875rem;}
        .collapsible-body{padding:0 0.75rem 0.75rem;display:none;}
        .collapsible.open .collapsible-body{display:block;}
        .collapsible.open .collapse-icon{transform:rotate(180deg);}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:1000;padding:1rem;}
        .modal-overlay.show{display:flex;}
        .modal{background:var(--dark-surface);border:1px solid var(--dark-border);border-radius:12px;width:100%;max-width:700px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;}
        .modal-lg{max-width:900px;}
        .modal-header{padding:1rem 1.25rem;border-bottom:1px solid var(--dark-border);display:flex;justify-content:space-between;align-items:center;}
        .modal-title{font-weight:600;color:var(--gold);font-size:1.1rem;}
        .modal-close{background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer;line-height:1;}
        .modal-body{padding:1.25rem;overflow-y:auto;flex:1;}
        .modal-footer{padding:1rem 1.25rem;border-top:1px solid var(--dark-border);display:flex;justify-content:flex-end;gap:0.5rem;}
        .tabs{display:flex;gap:0.25rem;margin-bottom:1rem;border-bottom:1px solid var(--dark-border);padding-bottom:0.5rem;}
        .tab{padding:0.5rem 1rem;background:transparent;border:none;color:var(--text-muted);cursor:pointer;font-size:0.875rem;border-radius:6px 6px 0 0;}
        .tab:hover{color:var(--text);}
        .tab.active{background:var(--dark-elevated);color:var(--gold);font-weight:600;}
        .tab-content{display:none;}
        .tab-content.active{display:block;}
        .api-card{background:var(--dark-elevated);border:1px solid var(--dark-border);border-radius:8px;padding:1rem;margin-bottom:0.75rem;}
        .api-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;}
        .api-card-title{font-weight:600;display:flex;align-items:center;gap:0.5rem;}
        .api-status{font-size:0.75rem;padding:0.25rem 0.5rem;border-radius:4px;}
        .api-status.connected{background:rgba(34,197,94,0.2);color:var(--success);}
        .api-status.disconnected{background:rgba(239,68,68,0.2);color:var(--error);}
        .writer-card{background:var(--dark-elevated);border:1px solid var(--dark-border);border-radius:8px;padding:1rem;margin-bottom:0.75rem;cursor:pointer;transition:all 0.2s;}
        .writer-card:hover{border-color:var(--gold);}
        .writer-card.selected{border-color:var(--gold);background:rgba(212,175,55,0.1);}
        .writer-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem;}
        .writer-name{font-weight:600;font-size:1rem;}
        .writer-category{font-size:0.7rem;background:var(--dark-border);padding:0.2rem 0.5rem;border-radius:4px;color:var(--text-muted);}
        .writer-desc{font-size:0.8rem;color:var(--text-muted);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
        .writer-form-section{background:var(--dark-elevated);border-radius:8px;padding:1rem;margin-bottom:1rem;border:1px solid var(--dark-border);}
        .writer-form-section-title{font-weight:600;color:var(--gold);margin-bottom:0.75rem;font-size:0.9rem;display:flex;align-items:center;gap:0.5rem;}
        .tag-input{display:flex;flex-wrap:wrap;gap:0.25rem;padding:0.5rem;background:var(--dark-elevated);border:1px solid var(--dark-border);border-radius:8px;min-height:42px;}
        .tag{background:var(--gold);color:#000;padding:0.2rem 0.5rem;border-radius:4px;font-size:0.75rem;display:flex;align-items:center;gap:0.25rem;}
        .tag-remove{cursor:pointer;font-weight:bold;}
        .tag-input input{flex:1;min-width:100px;background:transparent;border:none;color:var(--text);outline:none;}
        .toast{position:fixed;bottom:1rem;right:1rem;padding:0.75rem 1rem;background:var(--dark-surface);border:1px solid var(--dark-border);border-radius:8px;transform:translateY(100px);opacity:0;transition:all 0.3s;z-index:2000;max-width:300px;}
        .toast.show{transform:translateY(0);opacity:1;}
        .spinner{width:16px;height:16px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;}
        @keyframes spin{to{transform:rotate(360deg);}}
        .status-indicator{display:flex;align-items:center;gap:0.5rem;font-size:0.75rem;}
        .status-dot{width:8px;height:8px;border-radius:50%;}
        .status-dot.ok{background:var(--success);}
        .status-dot.error{background:var(--error);}
        .status-dot.warning{background:var(--warning);}
        .help-text{font-size:0.7rem;color:var(--text-muted);margin-top:0.25rem;}
        .divider{height:1px;background:var(--dark-border);margin:1rem 0;}
        .badge{font-size:0.65rem;padding:0.15rem 0.4rem;border-radius:3px;background:var(--dark-border);color:var(--text-muted);}
        .preview-box{background:#000;border-radius:8px;padding:0.5rem;margin-top:0.5rem;font-size:0.8rem;color:var(--text-muted);max-height:100px;overflow-y:auto;}
    </style>
</head>
<body>
    <header class="header">
        <span class="logo">âœ¨ AI ëŒ€ë³¸ ìƒì„±ê¸° v2.0</span>
        <div class="header-btns">
            <button class="btn btn-secondary btn-sm" onclick="openSettingsModal()">âš™ï¸ ì„¤ì •</button>
            <button class="btn btn-secondary btn-sm" onclick="openWriterModal()">ğŸ‘¤ ì‘ê°€ ê´€ë¦¬</button>
            <div class="status-indicator" id="apiStatus">
                <span class="status-dot warning"></span>
                <span>API ë¯¸ì„¤ì •</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Left Panel: Settings -->
        <div class="panel">
            <div class="panel-header">âš™ï¸ ëŒ€ë³¸ ì„¤ì •</div>
            <div class="panel-body">
                <!-- AI Model Selection -->
                <div class="form-label">AI ëª¨ë¸ ì„ íƒ</div>
                <div class="ai-selector">
                    <div class="ai-option" data-ai="gemini" onclick="selectAI(this)">
                        <div class="ai-icon">âš¡</div>
                        <div class="ai-name">Gemini</div>
                        <div class="ai-desc">ë¹ ë¦„/ì €ë ´</div>
                        <div class="ai-status no" id="gemini-status">ë¯¸ì—°ê²°</div>
                    </div>
                    <div class="ai-option" data-ai="claude" onclick="selectAI(this)">
                        <div class="ai-icon">ğŸ¨</div>
                        <div class="ai-name">Claude</div>
                        <div class="ai-desc">ê³ í’ˆì§ˆ</div>
                        <div class="ai-status no" id="claude-status">ë¯¸ì—°ê²°</div>
                    </div>
                    <div class="ai-option" data-ai="openai" onclick="selectAI(this)">
                        <div class="ai-icon">ğŸ¤–</div>
                        <div class="ai-name">GPT-4o</div>
                        <div class="ai-desc">ê· í˜•</div>
                        <div class="ai-status no" id="openai-status">ë¯¸ì—°ê²°</div>
                    </div>
                </div>

                <!-- Writer Selection -->
                <div class="form-group">
                    <label class="form-label">ì‘ê°€ í˜ë¥´ì†Œë‚˜</label>
                    <div style="display:flex;gap:0.5rem;">
                        <select class="form-select" id="writerSelect" style="flex:1;">
                            <option value="">ê¸°ë³¸ (ì‘ê°€ ì—†ìŒ)</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="openWriterModal()">ê´€ë¦¬</button>
                    </div>
                    <div id="writerPreview" class="preview-box" style="display:none;"></div>
                </div>

                <!-- Topic -->
                <div class="form-group">
                    <label class="form-label">ì£¼ì œ *</label>
                    <input class="form-input" id="topic" placeholder="ì˜ˆ: 2025ë…„ ë¶€ë™ì‚° ì „ë§, ì§ì¥ì¸ ì¬í…Œí¬ ë¹„ë²•..." />
                </div>

                <!-- Category & Duration -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                        <select class="form-select" id="category">
                            <option value="real_estate">ğŸ  ë¶€ë™ì‚°</option>
                            <option value="finance">ğŸ’° ì¬í…Œí¬</option>
                            <option value="education" selected>ğŸ“š êµìœ¡</option>
                            <option value="entertainment">ğŸ¬ ì—”í„°í…Œì¸ë¨¼íŠ¸</option>
                            <option value="health">ğŸ’ª ê±´ê°•</option>
                            <option value="tech">ğŸ’» ê¸°ìˆ </option>
                            <option value="vlog">ğŸ“¹ ë¸Œì´ë¡œê·¸</option>
                            <option value="other">ğŸ“Œ ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë¶„ëŸ‰</label>
                        <select class="form-select" id="duration">
                            <option value="30sec">30ì´ˆ (ìˆí¼)</option>
                            <option value="1min">1ë¶„</option>
                            <option value="5min" selected>5ë¶„</option>
                            <option value="10min">10ë¶„</option>
                        </select>
                    </div>
                </div>

                <!-- Tone & Structure -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">í†¤ì•¤ë§¤ë„ˆ</label>
                        <select class="form-select" id="tone">
                            <option value="friendly" selected>ğŸ˜Š ì¹œê·¼í•œ</option>
                            <option value="professional">ğŸ‘” ì „ë¬¸ì </option>
                            <option value="humorous">ğŸ˜‚ ìœ ë¨¸ëŸ¬ìŠ¤</option>
                            <option value="dramatic">ğŸ­ ë“œë¼ë§ˆí‹±</option>
                            <option value="calm">ğŸ˜Œ ì°¨ë¶„í•œ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">êµ¬ì¡°</label>
                        <select class="form-select" id="structure">
                            <option value="hook_develop_resolve" selected>í›„í‚¹â†’ì „ê°œâ†’í•´ì†Œ</option>
                            <option value="four_act">ê¸°â†’ìŠ¹â†’ì „â†’ê²°</option>
                            <option value="problem_solution">ë¬¸ì œâ†’í•´ê²°</option>
                            <option value="listicle">ë¦¬ìŠ¤í‹°í´ (Nê°€ì§€)</option>
                        </select>
                    </div>
                </div>

                <!-- Collapsible: Audience -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <span>ğŸ‘¥ íƒ€ê²Ÿ ì²­ì¤‘</span>
                        <span class="collapse-icon">â–¼</span>
                    </div>
                    <div class="collapsible-body">
                        <div class="form-row-3">
                            <div class="form-group">
                                <label class="form-label">ì—°ë ¹</label>
                                <select class="form-select" id="audienceAge">
                                    <option value="all" selected>ì „ì²´</option>
                                    <option value="teen">10ëŒ€</option>
                                    <option value="20s">20ëŒ€</option>
                                    <option value="30s">30ëŒ€</option>
                                    <option value="40s">40ëŒ€</option>
                                    <option value="50s">50ëŒ€+</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì„±ë³„</label>
                                <select class="form-select" id="audienceGender">
                                    <option value="all" selected>ì „ì²´</option>
                                    <option value="male">ë‚¨ì„±</option>
                                    <option value="female">ì—¬ì„±</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">í˜ë¥´ì†Œë‚˜</label>
                                <select class="form-select" id="audiencePersona">
                                    <option value="general" selected>ì¼ë°˜</option>
                                    <option value="investor">íˆ¬ìì</option>
                                    <option value="first_buyer">ë‚´ì§‘ë§ˆë ¨</option>
                                    <option value="beginner">ì´ˆë³´ì</option>
                                    <option value="expert">ì „ë¬¸ê°€</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Collapsible: Hook & CTA -->
                <div class="collapsible">
                    <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                        <span>ğŸ¯ í›„í‚¹ & CTA</span>
                        <span class="collapse-icon">â–¼</span>
                    </div>
                    <div class="collapsible-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">í›„í‚¹ ìŠ¤íƒ€ì¼</label>
                                <select class="form-select" id="hookStyle">
                                    <option value="question" selected>â“ ì§ˆë¬¸í˜•</option>
                                    <option value="shock">ğŸ˜± ì¶©ê²©í˜•</option>
                                    <option value="empathy">ğŸ¤ ê³µê°í˜•</option>
                                    <option value="number">ğŸ“Š ìˆ«ì/í†µê³„í˜•</option>
                                    <option value="story">ğŸ“– ìŠ¤í† ë¦¬í˜•</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">CTA</label>
                                <select class="form-select" id="ctaType">
                                    <option value="subscribe" selected>ğŸ”” êµ¬ë…ìœ ë„</option>
                                    <option value="comment">ğŸ’¬ ëŒ“ê¸€ìœ ë„</option>
                                    <option value="like">ğŸ‘ ì¢‹ì•„ìš”ìœ ë„</option>
                                    <option value="share">ğŸ“¤ ê³µìœ ìœ ë„</option>
                                    <option value="none">ì—†ìŒ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Custom Instructions -->
                <div class="form-group">
                    <label class="form-label">ì¶”ê°€ ì§€ì¹¨ (ì„ íƒ)</label>
                    <textarea class="form-textarea" id="customInstructions" rows="3" placeholder="ì˜ˆ: 30ëŒ€ ì§ì¥ì¸ì—ê²Œ ë§í•˜ë“¯ì´, ~ìš” ì²´ ì‚¬ìš©, ì „ë¬¸ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ..."></textarea>
                    <button class="btn btn-secondary btn-sm btn-full" style="margin-top:0.5rem;" onclick="generateInstructions()">âœ¨ AIê°€ ì§€ì¹¨ ìƒì„±</button>
                </div>

                <!-- Auto Split -->
                <div style="margin-bottom:1rem;">
                    <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
                        <input type="checkbox" id="autoSplit" style="accent-color:var(--gold);width:16px;height:16px;" />
                        <span style="font-size:0.875rem;">ğŸ¬ ìƒì„± í›„ ìë™ ì¥ë©´ë¶„í• </span>
                    </label>
                </div>

                <!-- Generate Button -->
                <button class="btn btn-primary btn-full" id="generateBtn" onclick="generateScript()">
                    <span id="genText">âœ¨ ëŒ€ë³¸ ìƒì„±</span>
                    <span id="genSpinner" class="spinner" style="display:none;"></span>
                </button>
            </div>
        </div>


        <!-- Center Panel: Editor -->
        <div class="panel">
            <div class="panel-header">
                <span>ğŸ“ ëŒ€ë³¸ í¸ì§‘ê¸°</span>
                <div style="display:flex;gap:0.5rem;">
                    <button class="btn btn-secondary btn-sm" onclick="editScript()">âœï¸ AIìˆ˜ì •</button>
                    <button class="btn btn-secondary btn-sm" onclick="copyScript()">ğŸ“‹ ë³µì‚¬</button>
                </div>
            </div>
            <div class="panel-body" style="padding:0;">
                <div class="script-editor" id="editor" contenteditable="true">
                    <div class="placeholder">
                        <div style="font-size:3rem;margin-bottom:0.5rem;">ğŸ“</div>
                        <div>ì£¼ì œë¥¼ ì…ë ¥í•˜ê³  ìƒì„± ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
                        <div style="font-size:0.8rem;margin-top:0.5rem;">ë˜ëŠ” ì§ì ‘ ëŒ€ë³¸ì„ ì‘ì„±í•´ë„ ë©ë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>
            <div style="padding:1rem;border-top:1px solid var(--dark-border);display:flex;gap:0.5rem;flex-wrap:wrap;">
                <button class="btn btn-success btn-sm" onclick="approveScript()">âœ… ê²€ìˆ˜ì™„ë£Œ</button>
                <button class="btn btn-secondary btn-sm" onclick="splitScenes('auto')">ğŸ¬ ìë™ë¶„í• </button>
                <button class="btn btn-secondary btn-sm" onclick="openSplitModal()">âœ‚ï¸ ìˆ˜ë™ë¶„í• </button>
                <div style="flex:1;"></div>
                <span id="charCount" style="font-size:0.75rem;color:var(--text-muted);align-self:center;">0ì</span>
            </div>
        </div>

        <!-- Right Panel: Scenes -->
        <div class="panel">
            <div class="panel-header">
                <span>ğŸ¬ ì¥ë©´ ëª©ë¡</span>
                <span id="sceneCount" style="font-size:0.75rem;color:var(--text-muted);">0ê°œ</span>
            </div>
            <div class="panel-body" id="scenesContainer">
                <div class="placeholder">
                    <div style="font-size:2rem;margin-bottom:0.5rem;">ğŸ¬</div>
                    <div>ëŒ€ë³¸ ê²€ìˆ˜ í›„ ì¥ë©´ë¶„í• </div>
                </div>
            </div>
            <div style="padding:1rem;border-top:1px solid var(--dark-border);">
                <button class="btn btn-primary btn-sm btn-full" onclick="exportScenes()" id="exportBtn" disabled>ğŸ“¤ JSON ë‚´ë³´ë‚´ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <span class="modal-title">âš™ï¸ API ì„¤ì •</span>
                <button class="modal-close" onclick="closeSettingsModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="showSettingsTab('api')">ğŸ”‘ API í‚¤</button>
                    <button class="tab" onclick="showSettingsTab('advanced')">ğŸ”§ ê³ ê¸‰ ì„¤ì •</button>
                </div>

                <!-- API Keys Tab -->
                <div class="tab-content active" id="tab-api">
                    <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:1rem;">
                        ê° AI ì„œë¹„ìŠ¤ì˜ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”. í‚¤ëŠ” ë¡œì»¬ì— ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.
                    </p>

                    <!-- Gemini -->
                    <div class="api-card">
                        <div class="api-card-header">
                            <div class="api-card-title">âš¡ Google Gemini</div>
                            <span class="api-status disconnected" id="gemini-api-status">ë¯¸ì—°ê²°</span>
                        </div>
                        <div class="form-group" style="margin-bottom:0.5rem;">
                            <input class="form-input" type="password" id="geminiApiKey" placeholder="AIzaSy..." />
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="testApiKey('gemini')">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                            <a href="https://aistudio.google.com/apikey" target="_blank" class="btn btn-secondary btn-sm">í‚¤ ë°œê¸‰ â†’</a>
                        </div>
                    </div>

                    <!-- Claude -->
                    <div class="api-card">
                        <div class="api-card-header">
                            <div class="api-card-title">ğŸ¨ Anthropic Claude</div>
                            <span class="api-status disconnected" id="claude-api-status">ë¯¸ì—°ê²°</span>
                        </div>
                        <div class="form-group" style="margin-bottom:0.5rem;">
                            <input class="form-input" type="password" id="claudeApiKey" placeholder="sk-ant-..." />
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="testApiKey('claude')">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                            <a href="https://console.anthropic.com/settings/keys" target="_blank" class="btn btn-secondary btn-sm">í‚¤ ë°œê¸‰ â†’</a>
                        </div>
                    </div>

                    <!-- OpenAI -->
                    <div class="api-card">
                        <div class="api-card-header">
                            <div class="api-card-title">ğŸ¤– OpenAI GPT-4o</div>
                            <span class="api-status disconnected" id="openai-api-status">ë¯¸ì—°ê²°</span>
                        </div>
                        <div class="form-group" style="margin-bottom:0.5rem;">
                            <input class="form-input" type="password" id="openaiApiKey" placeholder="sk-..." />
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="testApiKey('openai')">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                            <a href="https://platform.openai.com/api-keys" target="_blank" class="btn btn-secondary btn-sm">í‚¤ ë°œê¸‰ â†’</a>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- RAG Server -->
                    <div class="api-card">
                        <div class="api-card-header">
                            <div class="api-card-title">ğŸ—„ï¸ RAG ì„œë²„ (ì‘ê°€ ì €ì¥ìš©)</div>
                            <span class="api-status disconnected" id="rag-api-status">ë¯¸ì—°ê²°</span>
                        </div>
                        <div class="form-group" style="margin-bottom:0.5rem;">
                            <input class="form-input" id="ragServerUrl" placeholder="http://152.42.210.15:8000" />
                            <div class="help-text">ì‘ê°€ ë°ì´í„°ë¥¼ ì €ì¥í•  ì„œë²„ ì£¼ì†Œ (ì„ íƒì‚¬í•­, ì—†ìœ¼ë©´ ë¡œì»¬ ì €ì¥)</div>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="testRagServer()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                    </div>
                </div>

                <!-- Advanced Tab -->
                <div class="tab-content" id="tab-advanced">
                    <div class="form-group">
                        <label class="form-label">ê¸°ë³¸ AI ëª¨ë¸</label>
                        <select class="form-select" id="defaultAI">
                            <option value="gemini">Gemini (ê¶Œì¥)</option>
                            <option value="claude">Claude</option>
                            <option value="openai">GPT-4o</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ìƒì„± ì˜¨ë„ (ì°½ì˜ì„±)</label>
                        <input class="form-input" type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" />
                        <div class="help-text">ë‚®ì„ìˆ˜ë¡ ì¼ê´€ì„±, ë†’ì„ìˆ˜ë¡ ì°½ì˜ì„±</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="exportSettings()">ğŸ“¤ ì„¤ì • ë‚´ë³´ë‚´ê¸°</button>
                <button class="btn btn-secondary" onclick="importSettings()">ğŸ“¥ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ ì €ì¥</button>
            </div>
        </div>
    </div>


    <!-- Writer Management Modal -->
    <div class="modal-overlay" id="writerModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <span class="modal-title">ğŸ‘¤ ì‘ê°€ í˜ë¥´ì†Œë‚˜ ê´€ë¦¬</span>
                <button class="modal-close" onclick="closeWriterModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button class="tab active" onclick="showWriterTab('list')">ğŸ“‹ ì‘ê°€ ëª©ë¡</button>
                    <button class="tab" onclick="showWriterTab('create')">âœ¨ ìƒˆ ì‘ê°€ ë§Œë“¤ê¸°</button>
                </div>

                <!-- Writer List -->
                <div class="tab-content active" id="tab-list">
                    <div id="writerListContainer">
                        <div class="placeholder">ì €ì¥ëœ ì‘ê°€ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                </div>

                <!-- Writer Create/Edit Form -->
                <div class="tab-content" id="tab-create">
                    <input type="hidden" id="editingWriterId" value="" />

                    <!-- Basic Info -->
                    <div class="writer-form-section">
                        <div class="writer-form-section-title">ğŸ“Œ ê¸°ë³¸ ì •ë³´</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ì‘ê°€ ì´ë¦„ *</label>
                                <input class="form-input" id="wName" placeholder="ì˜ˆ: ë¶€ë™ì‚° ì „ë¬¸ê°€, ì¹œê·¼í•œ ì„ ë°°..." />
                            </div>
                            <div class="form-group">
                                <label class="form-label">ì „ë¬¸ ë¶„ì•¼</label>
                                <select class="form-select" id="wCategory">
                                    <option value="general">ì¼ë°˜</option>
                                    <option value="real_estate">ë¶€ë™ì‚°</option>
                                    <option value="finance">ì¬í…Œí¬</option>
                                    <option value="education">êµìœ¡</option>
                                    <option value="entertainment">ì—”í„°í…Œì¸ë¨¼íŠ¸</option>
                                    <option value="health">ê±´ê°•</option>
                                    <option value="tech">ê¸°ìˆ </option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">í•œì¤„ ì„¤ëª…</label>
                            <input class="form-input" id="wDescription" placeholder="ì´ ì‘ê°€ì˜ íŠ¹ì§•ì„ í•œì¤„ë¡œ ì„¤ëª…" />
                        </div>
                    </div>

                    <!-- Persona -->
                    <div class="writer-form-section">
                        <div class="writer-form-section-title">ğŸ­ í˜ë¥´ì†Œë‚˜ (ìºë¦­í„°)</div>
                        <div class="form-group">
                            <label class="form-label">ì‘ê°€ ìºë¦­í„° ì„¤ì •</label>
                            <textarea class="form-textarea" id="wPersona" rows="4" placeholder="ì˜ˆ: 20ë…„ ê²½ë ¥ì˜ ê³µì¸ì¤‘ê°œì‚¬ë¡œ, ê°•ë‚¨ ì¬ê±´ì¶• ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë³µì¡í•œ ë¶€ë™ì‚° ì •ì±…ì„ ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…í•˜ëŠ” ê²ƒì´ íŠ¹ê¸°ì…ë‹ˆë‹¤. í•­ìƒ ì‹œì²­ìì˜ ì´ìµì„ ë¨¼ì € ìƒê°í•©ë‹ˆë‹¤..."></textarea>
                            <div class="help-text">ì‘ê°€ê°€ ì–´ë–¤ ì‚¬ëŒì¸ì§€, ì–´ë–¤ ì „ë¬¸ì„±ì„ ê°€ì¡ŒëŠ”ì§€ ìƒì„¸íˆ ê¸°ìˆ </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ì‘ê°€ì˜ ëª©í‘œ/ê°€ì¹˜ê´€</label>
                            <textarea class="form-textarea" id="wGoals" rows="2" placeholder="ì˜ˆ: ì‹œì²­ìë“¤ì´ ë¶€ë™ì‚° ì‚¬ê¸°ë¥¼ ë‹¹í•˜ì§€ ì•Šë„ë¡ ì •í™•í•œ ì •ë³´ë¥¼ ì „ë‹¬í•˜ê³ ì í•©ë‹ˆë‹¤..."></textarea>
                        </div>
                    </div>

                    <!-- Speech Style -->
                    <div class="writer-form-section">
                        <div class="writer-form-section-title">ğŸ’¬ ë§íˆ¬ & ì–´íˆ¬</div>
                        <div class="form-group">
                            <label class="form-label">ë§íˆ¬ ìŠ¤íƒ€ì¼</label>
                            <textarea class="form-textarea" id="wSpeechStyle" rows="4" placeholder="ì˜ˆ: 
- '~ì…ë‹ˆë‹¤' ì²´ ëŒ€ì‹  '~í•´ìš”' ì²´ ì‚¬ìš©
- ì „ë¬¸ìš©ì–´ëŠ” ë°˜ë“œì‹œ ì‰¬ìš´ ë§ë¡œ í’€ì–´ì„œ ì„¤ëª…
- ì¤‘ìš”í•œ ë¶€ë¶„ì€ 'ì, ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ê±´ìš”~' ì‹ìœ¼ë¡œ ê°•ì¡°
- ë¬¸ì¥ì€ ì§§ê²Œ, í˜¸í¡ì€ ìì—°ìŠ¤ëŸ½ê²Œ
- ê°íƒ„ì‚¬: 'ì™€~', 'ì•„~' ìì£¼ ì‚¬ìš©"></textarea>
                            <div class="help-text">êµ¬ì²´ì ì¸ ë§íˆ¬ ì˜ˆì‹œì™€ íŒ¨í„´ì„ ê¸°ìˆ </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">í†¤/ë¶„ìœ„ê¸°</label>
                            <select class="form-select" id="wTone">
                                <option value="friendly">ğŸ˜Š ì¹œê·¼í•˜ê³  í¸ì•ˆí•œ</option>
                                <option value="professional">ğŸ‘” ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê° ìˆëŠ”</option>
                                <option value="energetic">âš¡ ì—ë„ˆì§€ ë„˜ì¹˜ëŠ”</option>
                                <option value="calm">ğŸ˜Œ ì°¨ë¶„í•˜ê³  ì•ˆì •ì ì¸</option>
                                <option value="humorous">ğŸ˜‚ ìœ ë¨¸ëŸ¬ìŠ¤í•œ</option>
                            </select>
                        </div>
                    </div>

                    <!-- Environment -->
                    <div class="writer-form-section">
                        <div class="writer-form-section-title">ğŸ¬ ìƒí™© ì„¤ì •</div>
                        <div class="form-group">
                            <label class="form-label">ë§í•˜ëŠ” ìƒí™©/í™˜ê²½</label>
                            <textarea class="form-textarea" id="wEnvironment" rows="3" placeholder="ì˜ˆ: ì¹´í˜ì—ì„œ ì¹œí•œ ë™ìƒì—ê²Œ ë¶€ë™ì‚° íŒì„ ì•Œë ¤ì£¼ëŠ” ìƒí™©. ì£¼ë³€ ì†ŒìŒì´ ìˆì–´ì„œ í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì „ë‹¬í•´ì•¼ í•¨. ë™ìƒì´ ì™„ì „ ì´ˆë³´ë¼ì„œ ê¸°ì´ˆë¶€í„° ì„¤ëª…..."></textarea>
                            <div class="help-text">ì–´ë–¤ ìƒí™©ì—ì„œ ë§í•˜ëŠ” ê²ƒì²˜ëŸ¼ ëŒ€ë³¸ì„ ì“¸ì§€ ì„¤ì •</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ê°€ìƒì˜ ì²­ì·¨ì</label>
                            <input class="form-input" id="wListener" placeholder="ì˜ˆ: ë¶€ë™ì‚°ì— ê´€ì‹¬ ìˆëŠ” 30ëŒ€ ì§ì¥ì¸ ë™ìƒ" />
                        </div>
                    </div>

                    <!-- Keywords & Forbidden -->
                    <div class="writer-form-section">
                        <div class="writer-form-section-title">ğŸ·ï¸ í‚¤ì›Œë“œ ê´€ë¦¬</div>
                        <div class="form-group">
                            <label class="form-label">í•„ìˆ˜ í¬í•¨ í‚¤ì›Œë“œ</label>
                            <div class="tag-input" id="requiredKeywordsInput">
                                <input type="text" placeholder="ì…ë ¥ í›„ Enter" onkeydown="addTag(event, 'required')" />
                            </div>
                            <div class="help-text">ëŒ€ë³¸ì— ê¼­ í¬í•¨ë˜ì–´ì•¼ í•  ë‹¨ì–´ë“¤</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ê¸ˆì§€ì–´</label>
                            <div class="tag-input" id="forbiddenWordsInput">
                                <input type="text" placeholder="ì…ë ¥ í›„ Enter" onkeydown="addTag(event, 'forbidden')" />
                            </div>
                            <div class="help-text">ëŒ€ë³¸ì— ì‚¬ìš©í•˜ë©´ ì•ˆ ë˜ëŠ” ë‹¨ì–´ë“¤</div>
                        </div>
                    </div>

                    <!-- Output Format -->
                    <div class="writer-form-section">
                        <div class="writer-form-section-title">ğŸ“„ ì¶œë ¥ í˜•ì‹</div>
                        <div class="form-group">
                            <label class="form-label">íŠ¹ë³„ ì¶œë ¥ ìš”êµ¬ì‚¬í•­</label>
                            <textarea class="form-textarea" id="wOutputFormat" rows="2" placeholder="ì˜ˆ: ê° ë¬¸ë‹¨ ì•ì— [ê°•ì¡°], [íŒ], [ì£¼ì˜] íƒœê·¸ ë¶™ì´ê¸°, ìˆ«ìëŠ” í•œê¸€ë¡œ í‘œê¸°..."></textarea>
                        </div>
                    </div>

                    <!-- Custom Instructions -->
                    <div class="writer-form-section">
                        <div class="writer-form-section-title">ğŸ“ ì¶”ê°€ ì§€ì¹¨</div>
                        <div class="form-group">
                            <label class="form-label">ê¸°íƒ€ ìƒì„¸ ì§€ì¹¨</label>
                            <textarea class="form-textarea" id="wCustomInstructions" rows="4" placeholder="ìœ„ í•­ëª©ì—ì„œ ë‹¤ë£¨ì§€ ëª»í•œ ì¶”ê°€ì ì¸ ì§€ì¹¨ì´ ìˆë‹¤ë©´ ììœ ë¡­ê²Œ ì‘ì„±..."></textarea>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-full" onclick="saveWriter()">ğŸ’¾ ì‘ê°€ ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Script Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">âœï¸ AI ëŒ€ë³¸ ìˆ˜ì •</span>
                <button class="modal-close" onclick="closeEditModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ìˆ˜ì • ìš”ì²­ì‚¬í•­</label>
                    <textarea class="form-textarea" id="editFeedback" rows="5" placeholder="ì˜ˆ: 
- ì„œë¡  ë¶€ë¶„ì„ ë” ì„íŒ©íŠ¸ ìˆê²Œ
- ì „ë¬¸ìš©ì–´ ì‰½ê²Œ í’€ì–´ì„œ
- ë§ˆì§€ë§‰ì— êµ¬ë… ìœ ë„ ì¶”ê°€"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEditModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="applyEdit()">âœ¨ AI ìˆ˜ì • ì ìš©</button>
            </div>
        </div>
    </div>

    <!-- Manual Split Modal -->
    <div class="modal-overlay" id="splitModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">âœ‚ï¸ ìˆ˜ë™ ì¥ë©´ ë¶„í• </span>
                <button class="modal-close" onclick="closeSplitModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ë¶„í• í•  ì¥ë©´ ìˆ˜</label>
                    <input class="form-input" type="number" id="sceneCountInput" value="10" min="2" max="50" />
                    <div class="help-text">2~50ê°œ ì‚¬ì´ë¡œ ì…ë ¥</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSplitModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="applyManualSplit()">âœ‚ï¸ ë¶„í• í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="settingsFileInput" accept=".json" style="display:none" onchange="handleSettingsImport(event)" />

    <!-- Toast -->
    <div class="toast" id="toast"></div>


    <script>
        // ============================================
        // State
        // ============================================
        let selectedAI = 'gemini';
        let currentScript = '';
        let scenes = [];
        let writers = [];
        let approved = false;
        let apiKeys = { gemini: '', claude: '', openai: '' };
        let apiStatus = { gemini: false, claude: false, openai: false };
        let ragServerUrl = '';
        let requiredKeywords = [];
        let forbiddenWords = [];

        // ============================================
        // API Error Handler (HTTP ìƒíƒœ ì½”ë“œë³„ ì²˜ë¦¬)
        // ============================================
        function handleApiError(status, action = 'API ìš”ì²­') {
            switch (status) {
                case 429:
                    toast(`[${action}] ìš”ì²­ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (Rate Limit)`, 'error');
                    break;
                case 401:
                    toast(`[${action}] API í‚¤ ë˜ëŠ” ì¸ì¦ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`, 'error');
                    openSettingsModal();
                    break;
                case 403:
                    toast(`[${action}] ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. API í‚¤ ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.`, 'error');
                    break;
                case 500:
                    toast(`[${action}] ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. API í‚¤ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.`, 'error');
                    break;
                case 503:
                    toast(`[${action}] ì„œë¹„ìŠ¤ë¥¼ ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.`, 'error');
                    break;
                default:
                    toast(`[${action}] ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (${status})`, 'error');
            }
        }

        // ============================================
        // Initialization
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadWriters();
            setupEditorEvents();
            updateApiStatusIndicator();
        });

        function setupEditorEvents() {
            const editor = document.getElementById('editor');
            editor.addEventListener('input', () => {
                const text = editor.innerText;
                document.getElementById('charCount').textContent = text.length + 'ì';
                if (text.trim() && !text.includes('ì£¼ì œë¥¼ ì…ë ¥')) {
                    approved = false;
                }
            });
            editor.addEventListener('focus', () => {
                if (editor.querySelector('.placeholder')) {
                    editor.innerHTML = '';
                }
            });
        }

        // ============================================
        // AI Selection
        // ============================================
        function selectAI(el) {
            const ai = el.dataset.ai;
            if (!apiStatus[ai]) {
                toast('API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }
            document.querySelectorAll('.ai-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedAI = ai;
        }

        function updateAISelectors() {
            document.querySelectorAll('.ai-option').forEach(el => {
                const ai = el.dataset.ai;
                const statusEl = el.querySelector('.ai-status');
                if (apiStatus[ai]) {
                    statusEl.textContent = 'ì—°ê²°ë¨';
                    statusEl.className = 'ai-status ok';
                    el.classList.remove('disabled');
                } else {
                    statusEl.textContent = 'ë¯¸ì—°ê²°';
                    statusEl.className = 'ai-status no';
                    if (selectedAI === ai) {
                        el.classList.remove('selected');
                    }
                }
            });
            // Auto-select first available
            if (!apiStatus[selectedAI]) {
                for (const ai of ['gemini', 'claude', 'openai']) {
                    if (apiStatus[ai]) {
                        selectedAI = ai;
                        document.querySelector(`.ai-option[data-ai="${ai}"]`).classList.add('selected');
                        break;
                    }
                }
            }
        }

        // ============================================
        // Settings Modal
        // ============================================
        function openSettingsModal() {
            document.getElementById('settingsModal').classList.add('show');
            // Load saved keys (masked)
            document.getElementById('geminiApiKey').value = apiKeys.gemini;
            document.getElementById('claudeApiKey').value = apiKeys.claude;
            document.getElementById('openaiApiKey').value = apiKeys.openai;
            document.getElementById('ragServerUrl').value = ragServerUrl;
            updateSettingsStatus();
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function showSettingsTab(tab) {
            document.querySelectorAll('#settingsModal .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#settingsModal .tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`#settingsModal .tab:nth-child(${tab === 'api' ? 1 : 2})`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        function updateSettingsStatus() {
            ['gemini', 'claude', 'openai'].forEach(ai => {
                const statusEl = document.getElementById(`${ai}-api-status`);
                if (apiStatus[ai]) {
                    statusEl.textContent = 'ì—°ê²°ë¨';
                    statusEl.className = 'api-status connected';
                } else {
                    statusEl.textContent = 'ë¯¸ì—°ê²°';
                    statusEl.className = 'api-status disconnected';
                }
            });
        }

        async function testApiKey(provider) {
            const keyInput = document.getElementById(`${provider}ApiKey`);
            const key = keyInput.value.trim();
            if (!key) {
                toast('API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            toast('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
            try {
                const res = await fetch('/api/test-api-key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider, api_key: key })
                });
                const data = await res.json();
                if (data.success) {
                    apiStatus[provider] = true;
                    apiKeys[provider] = key;
                    toast(`${provider} ì—°ê²° ì„±ê³µ!`);
                } else {
                    apiStatus[provider] = false;
                    toast(data.error || 'ì—°ê²° ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                apiStatus[provider] = false;
                toast('ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ' + e.message, 'error');
            }
            updateSettingsStatus();
            updateAISelectors();
            updateApiStatusIndicator();
        }

        async function testRagServer() {
            const url = document.getElementById('ragServerUrl').value.trim();
            if (!url) {
                toast('ì„œë²„ URLì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            toast('ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
            try {
                const res = await fetch(url + '/health');
                if (res.ok) {
                    ragServerUrl = url;
                    document.getElementById('rag-api-status').textContent = 'ì—°ê²°ë¨';
                    document.getElementById('rag-api-status').className = 'api-status connected';
                    toast('RAG ì„œë²„ ì—°ê²° ì„±ê³µ!');
                } else {
                    throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                }
            } catch (e) {
                document.getElementById('rag-api-status').textContent = 'ë¯¸ì—°ê²°';
                document.getElementById('rag-api-status').className = 'api-status disconnected';
                toast('RAG ì„œë²„ ì—°ê²° ì‹¤íŒ¨', 'error');
            }
        }

        function saveSettings() {
            apiKeys.gemini = document.getElementById('geminiApiKey').value.trim();
            apiKeys.claude = document.getElementById('claudeApiKey').value.trim();
            apiKeys.openai = document.getElementById('openaiApiKey').value.trim();
            ragServerUrl = document.getElementById('ragServerUrl').value.trim();

            const settings = {
                apiKeys: apiKeys,
                ragServerUrl: ragServerUrl,
                defaultAI: document.getElementById('defaultAI').value,
                temperature: document.getElementById('temperature').value
            };
            localStorage.setItem('m06_settings', btoa(JSON.stringify(settings)));

            // Send to server
            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ api_keys: apiKeys, rag_server_url: ragServerUrl })
            });

            toast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeSettingsModal();
            updateAISelectors();
            updateApiStatusIndicator();
        }

        function loadSettings() {
            const saved = localStorage.getItem('m06_settings');
            if (saved) {
                try {
                    const settings = JSON.parse(atob(saved));
                    apiKeys = settings.apiKeys || { gemini: '', claude: '', openai: '' };
                    ragServerUrl = settings.ragServerUrl || '';
                    if (settings.defaultAI) {
                        document.getElementById('defaultAI').value = settings.defaultAI;
                        selectedAI = settings.defaultAI;
                    }
                    if (settings.temperature) {
                        document.getElementById('temperature').value = settings.temperature;
                    }
                    // Check which APIs are configured
                    apiStatus.gemini = !!apiKeys.gemini;
                    apiStatus.claude = !!apiKeys.claude;
                    apiStatus.openai = !!apiKeys.openai;
                    updateAISelectors();
                } catch (e) {
                    console.error('Failed to load settings', e);
                }
            }
        }

        function updateApiStatusIndicator() {
            const indicator = document.getElementById('apiStatus');
            const connectedCount = Object.values(apiStatus).filter(Boolean).length;
            if (connectedCount === 0) {
                indicator.innerHTML = '<span class="status-dot warning"></span><span>API ë¯¸ì„¤ì •</span>';
            } else {
                indicator.innerHTML = `<span class="status-dot ok"></span><span>${connectedCount}ê°œ ì—°ê²°ë¨</span>`;
            }
        }

        function exportSettings() {
            const settings = {
                apiKeys: apiKeys,
                ragServerUrl: ragServerUrl,
                writers: writers,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `m06_settings_${Date.now()}.json`;
            a.click();
            toast('ì„¤ì • ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!');
        }

        function importSettings() {
            document.getElementById('settingsFileInput').click();
        }

        function handleSettingsImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const settings = JSON.parse(e.target.result);
                    if (settings.apiKeys) {
                        apiKeys = settings.apiKeys;
                        document.getElementById('geminiApiKey').value = apiKeys.gemini || '';
                        document.getElementById('claudeApiKey').value = apiKeys.claude || '';
                        document.getElementById('openaiApiKey').value = apiKeys.openai || '';
                    }
                    if (settings.ragServerUrl) {
                        ragServerUrl = settings.ragServerUrl;
                        document.getElementById('ragServerUrl').value = ragServerUrl;
                    }
                    if (settings.writers) {
                        writers = settings.writers;
                        renderWriterList();
                        updateWriterSelect();
                    }
                    toast('ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
                } catch (err) {
                    toast('ì˜ëª»ëœ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤', 'error');
                }
            };
            reader.readAsText(file);
        }


        // ============================================
        // Writer Management
        // ============================================
        function openWriterModal() {
            document.getElementById('writerModal').classList.add('show');
            loadWriters();
        }

        function closeWriterModal() {
            document.getElementById('writerModal').classList.remove('show');
            resetWriterForm();
        }

        function showWriterTab(tab) {
            document.querySelectorAll('#writerModal .tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#writerModal .tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`#writerModal .tab:nth-child(${tab === 'list' ? 1 : 2})`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            if (tab === 'create') {
                resetWriterForm();
            }
        }

        function resetWriterForm() {
            document.getElementById('editingWriterId').value = '';
            ['wName', 'wCategory', 'wDescription', 'wPersona', 'wGoals', 'wSpeechStyle', 'wTone', 'wEnvironment', 'wListener', 'wOutputFormat', 'wCustomInstructions'].forEach(id => {
                const el = document.getElementById(id);
                if (el.tagName === 'SELECT') el.selectedIndex = 0;
                else el.value = '';
            });
            requiredKeywords = [];
            forbiddenWords = [];
            renderTags();
        }

        async function loadWriters() {
            try {
                const res = await fetch('/api/writers');
                const data = await res.json();
                writers = data.writers || [];
            } catch (e) {
                writers = [];
            }
            renderWriterList();
            updateWriterSelect();
        }

        function renderWriterList() {
            const container = document.getElementById('writerListContainer');
            if (!writers.length) {
                container.innerHTML = '<div class="placeholder">ì €ì¥ëœ ì‘ê°€ê°€ ì—†ìŠµë‹ˆë‹¤<br><small>ìƒˆ ì‘ê°€ ë§Œë“¤ê¸° íƒ­ì—ì„œ ì‘ê°€ë¥¼ ìƒì„±í•˜ì„¸ìš”</small></div>';
                return;
            }
            container.innerHTML = writers.map(w => `
                <div class="writer-card" onclick="selectWriterFromList('${w.id}')">
                    <div class="writer-header">
                        <div class="writer-name">${w.name}</div>
                        <span class="writer-category">${getCategoryLabel(w.category)}</span>
                    </div>
                    <div class="writer-desc">${w.description || w.persona?.substring(0, 100) || 'ì„¤ëª… ì—†ìŒ'}</div>
                    <div style="margin-top:0.5rem;display:flex;gap:0.5rem;">
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();editWriter('${w.id}')">âœï¸ ìˆ˜ì •</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteWriter('${w.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </div>
                </div>
            `).join('');
        }

        function getCategoryLabel(cat) {
            const labels = {
                general: 'ì¼ë°˜', real_estate: 'ë¶€ë™ì‚°', finance: 'ì¬í…Œí¬',
                education: 'êµìœ¡', entertainment: 'ì—”í„°', health: 'ê±´ê°•', tech: 'ê¸°ìˆ '
            };
            return labels[cat] || cat || 'ì¼ë°˜';
        }

        function updateWriterSelect() {
            const select = document.getElementById('writerSelect');
            select.innerHTML = '<option value="">ê¸°ë³¸ (ì‘ê°€ ì—†ìŒ)</option>' +
                writers.map(w => `<option value="${w.id}">${w.name} (${getCategoryLabel(w.category)})</option>`).join('');
        }

        function selectWriterFromList(id) {
            document.getElementById('writerSelect').value = id;
            closeWriterModal();
            showWriterPreview(id);
            toast('ì‘ê°€ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        function showWriterPreview(id) {
            const preview = document.getElementById('writerPreview');
            const writer = writers.find(w => w.id === id);
            if (writer) {
                preview.style.display = 'block';
                preview.innerHTML = `<strong>${writer.name}</strong><br>${writer.persona?.substring(0, 150) || ''}...`;
            } else {
                preview.style.display = 'none';
            }
        }

        document.getElementById('writerSelect').addEventListener('change', function() {
            showWriterPreview(this.value);
        });

        function editWriter(id) {
            const writer = writers.find(w => w.id === id);
            if (!writer) return;

            document.getElementById('editingWriterId').value = writer.id;
            document.getElementById('wName').value = writer.name || '';
            document.getElementById('wCategory').value = writer.category || 'general';
            document.getElementById('wDescription').value = writer.description || '';
            document.getElementById('wPersona').value = writer.persona || '';
            document.getElementById('wGoals').value = writer.goals || '';
            document.getElementById('wSpeechStyle').value = writer.speech_style || '';
            document.getElementById('wTone').value = writer.tone || 'friendly';
            document.getElementById('wEnvironment').value = writer.environment || '';
            document.getElementById('wListener').value = writer.listener || '';
            document.getElementById('wOutputFormat').value = writer.output_format || '';
            document.getElementById('wCustomInstructions').value = writer.custom_instructions || '';

            requiredKeywords = writer.required_keywords || [];
            forbiddenWords = writer.forbidden_words || [];
            renderTags();

            showWriterTab('create');
        }

        async function saveWriter() {
            const name = document.getElementById('wName').value.trim();
            if (!name) {
                toast('ì‘ê°€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            const editingId = document.getElementById('editingWriterId').value;
            const writer = {
                id: editingId || `writer_${Date.now()}`,
                name: name,
                category: document.getElementById('wCategory').value,
                description: document.getElementById('wDescription').value,
                persona: document.getElementById('wPersona').value,
                goals: document.getElementById('wGoals').value,
                speech_style: document.getElementById('wSpeechStyle').value,
                tone: document.getElementById('wTone').value,
                environment: document.getElementById('wEnvironment').value,
                listener: document.getElementById('wListener').value,
                output_format: document.getElementById('wOutputFormat').value,
                custom_instructions: document.getElementById('wCustomInstructions').value,
                required_keywords: requiredKeywords,
                forbidden_words: forbiddenWords,
                updated_at: new Date().toISOString()
            };

            try {
                const res = await fetch('/api/writers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(writer)
                });
                const data = await res.json();
                if (data.success) {
                    toast('ì‘ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    loadWriters();
                    showWriterTab('list');
                } else {
                    toast(data.error || 'ì €ì¥ ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                toast('ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
            }
        }

        async function deleteWriter(id) {
            if (!confirm('ì´ ì‘ê°€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
                await fetch(`/api/writers/${id}`, { method: 'DELETE' });
                toast('ì‘ê°€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                loadWriters();
            } catch (e) {
                toast('ì‚­ì œ ì‹¤íŒ¨', 'error');
            }
        }

        // Tag Input
        function addTag(event, type) {
            if (event.key !== 'Enter') return;
            event.preventDefault();
            const input = event.target;
            const value = input.value.trim();
            if (!value) return;

            if (type === 'required') {
                if (!requiredKeywords.includes(value)) requiredKeywords.push(value);
            } else {
                if (!forbiddenWords.includes(value)) forbiddenWords.push(value);
            }
            input.value = '';
            renderTags();
        }

        function removeTag(type, index) {
            if (type === 'required') {
                requiredKeywords.splice(index, 1);
            } else {
                forbiddenWords.splice(index, 1);
            }
            renderTags();
        }

        function renderTags() {
            const reqContainer = document.getElementById('requiredKeywordsInput');
            const forbContainer = document.getElementById('forbiddenWordsInput');
            
            reqContainer.innerHTML = requiredKeywords.map((k, i) => 
                `<span class="tag">${k}<span class="tag-remove" onclick="removeTag('required',${i})">Ã—</span></span>`
            ).join('') + '<input type="text" placeholder="ì…ë ¥ í›„ Enter" onkeydown="addTag(event,\'required\')" />';
            
            forbContainer.innerHTML = forbiddenWords.map((k, i) => 
                `<span class="tag" style="background:var(--error);">${k}<span class="tag-remove" onclick="removeTag('forbidden',${i})">Ã—</span></span>`
            ).join('') + '<input type="text" placeholder="ì…ë ¥ í›„ Enter" onkeydown="addTag(event,\'forbidden\')" />';
        }


        // ============================================
        // Script Generation
        // ============================================
        async function generateScript() {
            const topic = document.getElementById('topic').value.trim();
            if (!topic) {
                toast('ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            if (!Object.values(apiStatus).some(Boolean)) {
                toast('API í‚¤ë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”. ì„¤ì • ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'error');
                openSettingsModal();
                return;
            }

            setLoading(true);
            try {
                const res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: topic,
                        ai_provider: selectedAI,
                        category: document.getElementById('category').value,
                        duration: document.getElementById('duration').value,
                        tone: document.getElementById('tone').value,
                        structure: document.getElementById('structure').value,
                        audience_age: document.getElementById('audienceAge').value,
                        audience_gender: document.getElementById('audienceGender').value,
                        audience_persona: document.getElementById('audiencePersona').value,
                        hook_style: document.getElementById('hookStyle').value,
                        cta_type: document.getElementById('ctaType').value,
                        custom_instructions: document.getElementById('customInstructions').value,
                        writer_id: document.getElementById('writerSelect').value || null,
                        auto_split_scenes: document.getElementById('autoSplit').checked
                    })
                });
                
                // HTTP ìƒíƒœ ì½”ë“œë³„ ì—ëŸ¬ ì²˜ë¦¬
                if (!res.ok) {
                    handleApiError(res.status, 'ëŒ€ë³¸ ìƒì„±');
                    setLoading(false);
                    return;
                }
                
                const data = await res.json();
                if (data.success) {
                    currentScript = data.script;
                    document.getElementById('editor').innerText = data.script;
                    document.getElementById('charCount').textContent = data.script.length + 'ì';
                    approved = false;
                    if (data.scenes && data.scenes.length) {
                        scenes = data.scenes;
                        renderScenes();
                    }
                    toast('ëŒ€ë³¸ ìƒì„± ì™„ë£Œ!');
                } else {
                    // ì„œë²„ ì‘ë‹µ ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œ ìƒíƒœ ì½”ë“œ ì¶”ì¶œ ì‹œë„
                    const errorMsg = data.error || '';
                    if (errorMsg.includes('429') || errorMsg.toLowerCase().includes('rate') || errorMsg.toLowerCase().includes('quota')) {
                        handleApiError(429, 'ëŒ€ë³¸ ìƒì„±');
                    } else if (errorMsg.includes('401') || errorMsg.toLowerCase().includes('auth') || errorMsg.toLowerCase().includes('key')) {
                        handleApiError(401, 'ëŒ€ë³¸ ìƒì„±');
                    } else {
                        toast(data.error || 'ìƒì„± ì‹¤íŒ¨', 'error');
                    }
                }
            } catch (e) {
                toast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + e.message, 'error');
            }
            setLoading(false);
        }

        function setLoading(loading) {
            document.getElementById('generateBtn').disabled = loading;
            document.getElementById('genText').style.display = loading ? 'none' : 'inline';
            document.getElementById('genSpinner').style.display = loading ? 'inline-block' : 'none';
        }

        // ============================================
        // Script Editing
        // ============================================
        function approveScript() {
            const text = document.getElementById('editor').innerText;
            if (!text || text.includes('ì£¼ì œë¥¼ ì…ë ¥')) {
                toast('ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            currentScript = text;
            approved = true;
            toast('ê²€ìˆ˜ ì™„ë£Œ! ì´ì œ ì¥ë©´ë¶„í• ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        function copyScript() {
            const text = document.getElementById('editor').innerText;
            navigator.clipboard.writeText(text);
            toast('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function openEditModal() {
            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        function editScript() {
            const text = document.getElementById('editor').innerText;
            if (!text || text.includes('ì£¼ì œë¥¼ ì…ë ¥')) {
                toast('ìˆ˜ì •í•  ëŒ€ë³¸ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            openEditModal();
        }

        async function applyEdit() {
            const feedback = document.getElementById('editFeedback').value.trim();
            if (!feedback) {
                toast('ìˆ˜ì • ìš”ì²­ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            toast('AI ìˆ˜ì • ì¤‘...');
            try {
                const res = await fetch('/api/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script: document.getElementById('editor').innerText,
                        feedback: feedback,
                        ai_provider: selectedAI
                    })
                });
                
                // HTTP ìƒíƒœ ì½”ë“œë³„ ì—ëŸ¬ ì²˜ë¦¬
                if (!res.ok) {
                    handleApiError(res.status, 'AI ìˆ˜ì •');
                    return;
                }
                
                const data = await res.json();
                if (data.success) {
                    document.getElementById('editor').innerText = data.script;
                    currentScript = data.script;
                    document.getElementById('charCount').textContent = data.script.length + 'ì';
                    approved = false;
                    closeEditModal();
                    document.getElementById('editFeedback').value = '';
                    toast('ëŒ€ë³¸ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    // ì„œë²„ ì‘ë‹µ ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œ ìƒíƒœ ì½”ë“œ ì¶”ì¶œ ì‹œë„
                    const errorMsg = data.error || '';
                    if (errorMsg.includes('429') || errorMsg.toLowerCase().includes('rate') || errorMsg.toLowerCase().includes('quota')) {
                        handleApiError(429, 'AI ìˆ˜ì •');
                    } else if (errorMsg.includes('401') || errorMsg.toLowerCase().includes('auth') || errorMsg.toLowerCase().includes('key')) {
                        handleApiError(401, 'AI ìˆ˜ì •');
                    } else {
                        toast(data.error || 'ìˆ˜ì • ì‹¤íŒ¨', 'error');
                    }
                }
            } catch (e) {
                toast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + e.message, 'error');
            }
        }

        // ============================================
        // Scene Splitting
        // ============================================
        function openSplitModal() {
            if (!approved) {
                toast('ë¨¼ì € ê²€ìˆ˜ì™„ë£Œë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”', 'error');
                return;
            }
            document.getElementById('splitModal').classList.add('show');
        }

        function closeSplitModal() {
            document.getElementById('splitModal').classList.remove('show');
        }

        async function splitScenes(mode, count = null) {
            if (!approved) {
                toast('ë¨¼ì € ê²€ìˆ˜ì™„ë£Œë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”', 'error');
                return;
            }

            toast('ì¥ë©´ ë¶„í•  ì¤‘...');
            try {
                const res = await fetch('/api/split-scenes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script: currentScript,
                        mode: mode,
                        ai_provider: selectedAI,
                        scene_count: count
                    })
                });
                
                // HTTP ìƒíƒœ ì½”ë“œë³„ ì—ëŸ¬ ì²˜ë¦¬
                if (!res.ok) {
                    handleApiError(res.status, 'ì¥ë©´ ë¶„í• ');
                    return;
                }
                
                const data = await res.json();
                if (data.success) {
                    scenes = data.scenes;
                    renderScenes();
                    toast(`${data.count}ê°œ ì¥ë©´ìœ¼ë¡œ ë¶„í• ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                } else {
                    // ì„œë²„ ì‘ë‹µ ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œ ìƒíƒœ ì½”ë“œ ì¶”ì¶œ ì‹œë„
                    const errorMsg = data.error || '';
                    if (errorMsg.includes('429') || errorMsg.toLowerCase().includes('rate') || errorMsg.toLowerCase().includes('quota')) {
                        handleApiError(429, 'ì¥ë©´ ë¶„í• ');
                    } else if (errorMsg.includes('401') || errorMsg.toLowerCase().includes('auth') || errorMsg.toLowerCase().includes('key')) {
                        handleApiError(401, 'ì¥ë©´ ë¶„í• ');
                    } else {
                        toast(data.error || 'ë¶„í•  ì‹¤íŒ¨', 'error');
                    }
                }
            } catch (e) {
                toast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + e.message, 'error');
            }
        }

        function applyManualSplit() {
            const count = parseInt(document.getElementById('sceneCountInput').value);
            if (count < 2 || count > 50) {
                toast('2~50 ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            closeSplitModal();
            splitScenes('manual', count);
        }

        function renderScenes() {
            const container = document.getElementById('scenesContainer');
            document.getElementById('sceneCount').textContent = scenes.length + 'ê°œ';
            document.getElementById('exportBtn').disabled = scenes.length === 0;

            if (!scenes.length) {
                container.innerHTML = '<div class="placeholder"><div style="font-size:2rem;">ğŸ¬</div>ëŒ€ë³¸ ê²€ìˆ˜ í›„ ì¥ë©´ë¶„í• </div>';
                return;
            }

            container.innerHTML = scenes.map(s => `
                <div class="scene-card">
                    <div class="scene-header">
                        <span class="scene-id">ì¥ë©´ ${s.scene_id}</span>
                        <span class="scene-meta">${s.emotion || 'neutral'}</span>
                    </div>
                    <div class="scene-text">${s.script_text || s.text || ''}</div>
                    ${s.keywords && s.keywords.length ? `<div style="margin-top:0.5rem;display:flex;gap:0.3rem;flex-wrap:wrap;">${s.keywords.map(k => `<span style="font-size:0.65rem;background:var(--gold);color:#000;padding:0.1rem 0.4rem;border-radius:0.2rem;">${k}</span>`).join('')}</div>` : ''}
                </div>
            `).join('');
        }

        function exportScenes() {
            if (!scenes.length) {
                toast('ë‚´ë³´ë‚¼ ì¥ë©´ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            // ìˆœìˆ˜ ë¶„í•  ëŒ€ë³¸ ì¶œë ¥ - M-07, M-08, M-09ì—ì„œ ê°ì í”„ë¡¬í”„íŠ¸ ìƒì„±
            const data = {
                project_id: `proj_${Date.now()}`,
                title: document.getElementById('topic').value || 'ë¬´ì œ',
                total_scenes: scenes.length,
                scenes: scenes.map(s => ({
                    scene_id: s.scene_id,
                    script_text: s.script_text || s.text || '',
                    keywords: s.keywords || [],
                    emotion: s.emotion || 'neutral'
                })),
                metadata: {
                    generated_at: new Date().toISOString(),
                    ai_provider: selectedAI,
                    source: 'm06_script',
                    version: '2.0'
                }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `script_scenes_${Date.now()}.json`;
            a.click();
            toast('JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!');
        }

        // ============================================
        // Generate Instructions
        // ============================================
        async function generateInstructions() {
            toast('AIê°€ ì§€ì¹¨ì„ ìƒì„± ì¤‘...');
            try {
                const res = await fetch('/api/generate-instructions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ai_provider: selectedAI,
                        category: document.getElementById('category').value,
                        tone: document.getElementById('tone').value,
                        audience_age: document.getElementById('audienceAge').value,
                        audience_persona: document.getElementById('audiencePersona').value,
                        hook_style: document.getElementById('hookStyle').value
                    })
                });
                const data = await res.json();
                if (data.success) {
                    const inst = data.instructions;
                    let text = '';
                    if (inst.persona) text += `[í˜ë¥´ì†Œë‚˜]\n${inst.persona}\n\n`;
                    if (inst.speech_style) text += `[ë§íˆ¬]\n${inst.speech_style}\n\n`;
                    if (inst.environment) text += `[í™˜ê²½]\n${inst.environment}`;
                    document.getElementById('customInstructions').value = text.trim();
                    toast('ì§€ì¹¨ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    toast(data.error || 'ìƒì„± ì‹¤íŒ¨', 'error');
                }
            } catch (e) {
                toast('ì˜¤ë¥˜: ' + e.message, 'error');
            }
        }

        // ============================================
        // Toast
        // ============================================
        function toast(message, type = 'success') {
            const el = document.getElementById('toast');
            el.innerHTML = (type === 'success' ? 'âœ… ' : 'âŒ ') + message;
            el.className = 'toast show';
            setTimeout(() => el.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
